const S={network:[/fetch failed/i,/network/i,/ERR_NETWORK/i,/ERR_CONNECTION/i,/ERR_INTERNET/i,/offline/i,/CORS/i,/Failed to fetch/i,/net::/i,/Connection refused/i,/timeout.*network/i],memory:[/out of memory/i,/OOM/i,/allocation failed/i,/memory limit/i,/heap/i,/RangeError.*Maximum/i,/WebAssembly.*memory/i,/wasm.*memory/i],model:[/model.*download/i,/model.*load/i,/model.*not found/i,/HuggingFace/i,/pipeline/i,/transformers/i,/ONNX/i,/wasm.*load/i,/WebGPU/i],language:[/unsupported language/i,/language pair/i,/invalid.*lang/i,/unknown language/i],timeout:[/timeout/i,/timed out/i,/deadline/i,/took too long/i],input:[/invalid input/i,/empty text/i,/text too long/i,/invalid character/i,/malformed/i]};function L(e){const t=e instanceof Error?e.message:String(e);for(const[r,n]of Object.entries(S))if(n.some(a=>a.test(t)))return r;return"internal"}function M(e){const t=e instanceof Error?e.message:String(e),r=L(e);switch(r){case"network":return{category:r,message:"Unable to connect to translation service",technicalDetails:t,retryable:!0,suggestion:"Check your internet connection and try again"};case"memory":return{category:r,message:"Not enough memory to complete translation",technicalDetails:t,retryable:!0,suggestion:"Try closing other tabs or using a smaller text selection"};case"model":return{category:r,message:"Translation model failed to load",technicalDetails:t,retryable:!0,suggestion:"The model may still be downloading. Please wait and try again."};case"language":return{category:r,message:"Language pair not supported",technicalDetails:t,retryable:!1,suggestion:"Please select a different source or target language"};case"timeout":return{category:r,message:"Translation took too long",technicalDetails:t,retryable:!0,suggestion:"Try with a shorter text or wait for the model to fully load"};case"input":return{category:r,message:"Invalid text for translation",technicalDetails:t,retryable:!1,suggestion:"Please check the text and try again"};default:return{category:"internal",message:"Translation failed unexpectedly",technicalDetails:t,retryable:!0,suggestion:"Please try again. If the problem persists, reload the extension."}}}const P={maxRetries:3,baseDelayMs:1e3,maxDelayMs:3e4,jitterFactor:.3};function $(e,t=P){const r=t.baseDelayMs*Math.pow(2,e),n=Math.min(r,t.maxDelayMs),a=n*t.jitterFactor*(Math.random()*2-1);return Math.max(t.baseDelayMs,Math.floor(n+a))}async function b(e,t={},r){const n={...P,...t};let a=null;for(let o=0;o<=n.maxRetries;o++)try{return await e()}catch(l){if(a=M(l),!(r?r(a):a.retryable)||o===n.maxRetries)throw l;const m=$(o,n);console.log(`[Retry] Attempt ${o+1}/${n.maxRetries} failed: ${a.message}. Retrying in ${m}ms...`),await new Promise(s=>setTimeout(s,m))}throw a}const w=1e4,x=100;function O(e,t,r){if(!e)return{valid:!1,error:{category:"input",message:"No text provided for translation",technicalDetails:"Input text was null, undefined, or empty",retryable:!1,suggestion:"Please select or enter some text to translate"}};if(Array.isArray(e)){if(e.length===0)return{valid:!1,error:{category:"input",message:"No text provided for translation",technicalDetails:"Input array was empty",retryable:!1}};if(e.length>x)return{valid:!1,error:{category:"input",message:`Too many texts in batch (max ${x})`,technicalDetails:`Batch size ${e.length} exceeds limit of ${x}`,retryable:!1,suggestion:"Please translate fewer items at once"}};const a=e.map(l=>R(l)),o=a.reduce((l,f)=>l+f.length,0);return o>w*2?{valid:!1,error:{category:"input",message:"Total text length exceeds maximum",technicalDetails:`Total length ${o} exceeds limit`,retryable:!1,suggestion:"Please translate smaller portions of text"}}:{valid:!0,sanitizedText:a}}const n=R(e);return n.length===0?{valid:!1,error:{category:"input",message:"Text contains no translatable content",technicalDetails:"After sanitization, text was empty",retryable:!1}}:n.length>w?{valid:!1,error:{category:"input",message:`Text too long (max ${w} characters)`,technicalDetails:`Text length ${n.length} exceeds limit of ${w}`,retryable:!1,suggestion:"Please select a smaller portion of text"}}:t!=="auto"&&!/^[a-z]{2,3}$/i.test(t)?{valid:!1,error:{category:"language",message:"Invalid source language code",technicalDetails:`Source language "${t}" is not a valid ISO code`,retryable:!1}}:/^[a-z]{2,3}$/i.test(r)?{valid:!0,sanitizedText:n}:{valid:!1,error:{category:"language",message:"Invalid target language code",technicalDetails:`Target language "${r}" is not a valid ISO code`,retryable:!1}}}function R(e){return e.normalize("NFC").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"").replace(/[ \t]+/g," ").trim()}function N(e){return L(e)==="network"}const E=100,i=new Map;function F(e,t,r,n){const a=Array.isArray(e)?e.map(l=>l.substring(0,50)).join("|").substring(0,200):e.substring(0,100);return`${n||c}:${t}-${r}-${a}`}function _(e){const t=i.get(e);return t&&(i.delete(e),i.set(e,t),console.log(`[Background] Cache HIT: ${e.substring(0,40)}...`)),t}function z(e,t,r,n){for(;i.size>=E;){const a=i.keys().next().value;a&&(i.delete(a),console.log("[Background] Cache evicted oldest entry"))}i.set(e,{result:t,timestamp:Date.now(),sourceLang:r,targetLang:n}),console.log(`[Background] Cached translation (${i.size}/${E})`)}function B(){let e=null;for(const t of i.values())(e===null||t.timestamp<e)&&(e=t.timestamp);return{size:i.size,maxSize:E,hitRate:`${d}/${d+h} (${d+h>0?Math.round(d/(d+h)*100):0}%)`,oldestEntry:e}}let d=0,h=0,g=null,T=0;const I=3,A={maxRetries:3,baseDelayMs:1e3,maxDelayMs:1e4},U={maxRetries:2,baseDelayMs:500,maxDelayMs:3e3};async function C(){const e=chrome.runtime.getURL("src/offscreen/offscreen.html");try{if((await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[e]})).length>0){T=0;return}if(g){await g;return}console.log("[Background] Creating offscreen document..."),g=chrome.offscreen.createDocument({url:e,reasons:[chrome.offscreen.Reason.WORKERS],justification:"Run Transformers.js ML inference in document context"}),await g,g=null,T=0,console.log("[Background] Offscreen document created successfully")}catch(t){g=null,T++;const r=t instanceof Error?t.message:String(t);throw console.error("[Background] Failed to create offscreen document:",r),T>=I?new Error("Translation engine failed to start. Please reload the extension or restart Chrome."):new Error(`Failed to initialize translation engine: ${r}`)}}async function q(){try{const e=chrome.runtime.getURL("src/offscreen/offscreen.html");(await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[e]})).length>0&&(await chrome.offscreen.closeDocument(),console.log("[Background] Closed existing offscreen document"))}catch(e){console.warn("[Background] Error closing offscreen document:",e)}g=null,await new Promise(e=>setTimeout(e,500)),await C()}async function D(e,t=5*60*1e3){return b(async()=>(await C(),new Promise((r,n)=>{const a=setTimeout(()=>{n(new Error("Offscreen communication timeout"))},t);try{chrome.runtime.sendMessage({...e,target:"offscreen"},o=>{if(clearTimeout(a),chrome.runtime.lastError){n(new Error(chrome.runtime.lastError.message));return}if(o===void 0){n(new Error("No response from translation engine"));return}r(o)})}catch(o){clearTimeout(a),n(o)}})),U,r=>r.retryable?(r.technicalDetails.includes("offscreen")&&(console.log("[Background] Attempting offscreen document reset..."),q().catch(console.error)),!0):!1)}let v="smart",c="opus-mt";const u={requests:0,tokens:0,windowStart:Date.now()},y={requestsPerMinute:60,tokensPerMinute:1e5,windowMs:6e4};function G(e){const t=Date.now();return t-u.windowStart>y.windowMs&&(u.requests=0,u.tokens=0,u.windowStart=t),!(u.requests>=y.requestsPerMinute||u.tokens+e>y.tokensPerMinute)}function H(e){u.requests++,u.tokens+=e}function K(e){const t=Array.isArray(e)?e.join(" "):e;return Math.max(1,Math.ceil(t.length/4))}function k(e){let t=e.message;return e.suggestion&&(t+=`. ${e.suggestion}`),t}chrome.runtime.onMessage.addListener((e,t,r)=>"target"in e&&e.target==="offscreen"?!1:(X(e).then(r).catch(n=>{const a=M(n);console.error("[Background] Error:",a.technicalDetails),r({success:!1,error:k(a)})}),!0));async function X(e){switch(e.type){case"ping":return{success:!0,status:"ready",provider:c};case"translate":return J(e);case"getUsage":return V();case"getProviders":return Q();case"preloadModel":return W(e);case"setProvider":return j(e);case"getCacheStats":return Y();case"clearCache":return Z();default:throw new Error(`Unknown message type: ${e.type}`)}}async function j(e){c=e.provider,console.log(`[Background] Provider set to: ${c}`);try{await chrome.storage.local.set({provider:c})}catch{}return{success:!0,provider:c}}async function W(e){const t=e.provider||c;console.log(`[Background] Preloading ${t} model: ${e.sourceLang} -> ${e.targetLang}`);try{return await D({type:"preloadModel",sourceLang:e.sourceLang,targetLang:e.targetLang,provider:t})}catch(r){return console.warn("[Background] Preload failed:",r),{success:!1,error:r instanceof Error?r.message:String(r)}}}function Y(){return{success:!0,cache:B()}}function Z(){const e=i.size;return i.clear(),d=0,h=0,console.log(`[Background] Cache cleared (was ${e} entries)`),{success:!0,clearedEntries:e}}async function J(e){const t=Date.now();try{const r=O(e.text,e.sourceLang,e.targetLang);if(!r.valid)return{success:!1,error:k(r.error),duration:Date.now()-t};const n=r.sanitizedText;e.options?.strategy&&(v=e.options.strategy);const a=e.provider||c,o=F(n,e.sourceLang,e.targetLang,a);if(e.sourceLang!=="auto"){const s=_(o);if(s){d++;const p=Date.now()-t;return console.log(`[Background] Cache hit, returning in ${p}ms`),{success:!0,result:s.result,duration:p,cached:!0}}}h++;const l=K(n);if(!G(l))return{success:!1,error:"Too many requests. Please wait a moment and try again.",duration:Date.now()-t};console.log("[Background] Translating:",e.sourceLang,"->",e.targetLang);const f=await b(async()=>{const s=await D({type:"translate",text:n,sourceLang:e.sourceLang,targetLang:e.targetLang,provider:a});if(!s)throw new Error("No response from translation engine");if(!s.success){const p=typeof s.error=="string"?s.error:s.error instanceof Error?s.error.message:JSON.stringify(s.error)||"Translation failed";throw new Error(p)}return s},A,s=>N(s.technicalDetails));console.log("[Background] Translation complete"),H(l);const m=e.sourceLang==="auto"?"auto":e.sourceLang;return f.result&&m!=="auto"&&z(o,f.result,m,e.targetLang),{success:!0,result:f.result,duration:Date.now()-t}}catch(r){const n=M(r);return console.error("[Background] Translation error:",n.technicalDetails),{success:!1,error:k(n),duration:Date.now()-t}}}function V(){return{throttle:{requests:u.requests,tokens:u.tokens,requestLimit:y.requestsPerMinute,tokenLimit:y.tokensPerMinute,queue:0},cache:B(),providers:{}}}async function Q(){try{const e=await D({type:"getSupportedLanguages"});return{providers:[{id:"opus-mt",name:"Helsinki-NLP OPUS-MT",type:"local",qualityTier:"standard",description:"Fast, lightweight (~170MB per pair)",icon:""},{id:"translategemma",name:"TranslateGemma 4B",type:"local",qualityTier:"premium",description:"High quality, single model (~3.6GB)",icon:""}],activeProvider:c,strategy:v,supportedLanguages:e.success?e.languages:[]}}catch(e){return console.warn("[Background] Error getting providers:",e),{providers:[{id:"opus-mt",name:"Helsinki-NLP OPUS-MT",type:"local",qualityTier:"standard",description:"Fast, lightweight (~170MB per pair)",icon:""},{id:"translategemma",name:"TranslateGemma 4B",type:"local",qualityTier:"premium",description:"High quality, single model (~3.6GB)",icon:""}],activeProvider:c,strategy:v,supportedLanguages:[],error:"Could not load language list. Translation may still work."}}}chrome.action.onClicked.addListener(async e=>{e.id&&console.log("[Background] Extension icon clicked for tab:",e.id)});chrome.runtime.onInstalled.addListener(e=>{e.reason==="install"?(console.log("[Background] Extension installed"),chrome.storage.local.set({sourceLang:"auto",targetLang:"fi",strategy:"smart",provider:"opus-mt"})):e.reason==="update"&&console.log("[Background] Extension updated from",e.previousVersion)});chrome.storage.local.get(["provider"],e=>{e.provider&&(c=e.provider,console.log("[Background] Restored provider:",c))});chrome.runtime.onStartup.addListener(()=>{console.log("[Background] Extension startup, pre-warming offscreen document..."),C().catch(e=>{console.warn("[Background] Pre-warm failed (will retry on first use):",e)})});console.log("[Background] Service worker initialized v2.2 with TranslateGemma + caching + preload");
//# sourceMappingURL=background.js.map
