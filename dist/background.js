import{c as de,C as h,p as g,v as Le,w as ge,i as Te}from"./assets/errors-CkzoS8ZC.js";import{c as I}from"./assets/logger-B_opVjnm.js";import{s as P,a as k,b as te}from"./assets/storage-CL8XEX39.js";function Se(e){let t=2166136261;for(let r=0;r<e.length;r++)t^=e.charCodeAt(r),t=Math.imul(t,16777619);return(t>>>0).toString(16).padStart(8,"0")}function be(e,t,r,o){const n=Array.isArray(e)?e.join("|||"):e,s=Se(n);return`${o}:${t}-${r}:${s}`}const v=I("PredictionEngine"),se=100,W=3,Ee=7*24*60*60*1e3,ie=1,_="predictionData";function Y(){return{domains:{},preferredTarget:"en",totalTranslations:0,lastTranslation:0,recentTranslations:0,recentWindowStart:Date.now()}}function ce(e){try{return new URL(e).hostname}catch{return null}}function ue(e,t){const r=t-e.lastSeen,o=Math.pow(.5,r/Ee);return e.count*o}function ke(e){const t=Object.values(e.domains);if(t.length<=se)return;t.sort((o,n)=>o.lastSeen-n.lastSeen);const r=t.length-se;for(let o=0;o<r;o++){const n=t[o].domain;delete e.domains[n],v.debug(`Evicted LRU domain: ${n}`)}}function A(e,t){t-e.recentWindowStart>864e5&&(e.recentTranslations=0,e.recentWindowStart=t)}class Me{data=null;saveTimeout=null;async load(){try{const t=await P([_]);this.data=t[_]||Y(),v.info(`Loaded prediction data: ${Object.keys(this.data.domains).length} domains`)}catch(t){v.warn("Failed to load prediction data:",t),this.data=Y()}}async save(){this.saveTimeout&&clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(async()=>{this.data&&await k({[_]:this.data})&&v.debug("Prediction data saved")},1e3)}async ensureLoaded(){return this.data||await this.load(),this.data}async recordDetection(t,r){const o=await this.ensureLoaded(),n=ce(t);if(!n){v.warn("Could not extract domain from URL:",t);return}const s=Date.now();o.domains[n]||(o.domains[n]={domain:n,languages:[],totalDetections:0,firstSeen:s,lastSeen:s});const l=o.domains[n];l.lastSeen=s,l.totalDetections++;let i=l.languages.find(u=>u.language===r);i||(i={language:r,count:0,lastSeen:s},l.languages.push(i)),i.count++,i.lastSeen=s,ke(o),v.debug(`Recorded detection: ${n} -> ${r} (count: ${i.count})`),await this.save()}async recordTranslation(t){const r=await this.ensureLoaded(),o=Date.now();A(r,o),r.totalTranslations++,r.lastTranslation=o,r.recentTranslations++,r.preferredTarget=t,v.debug(`Recorded translation: target=${t}, recent=${r.recentTranslations}`),await this.save()}async setPreferredTarget(t){const r=await this.ensureLoaded();r.preferredTarget=t,await this.save()}async getPreferredTarget(){return(await this.ensureLoaded()).preferredTarget}async hasRecentActivity(){const t=await this.ensureLoaded(),r=Date.now();return A(t,r),t.recentTranslations>=ie}async predict(t){const r=await this.ensureLoaded(),o=ce(t),n=Date.now(),s=r.preferredTarget,l=[];if(A(r,n),r.recentTranslations<ie)return v.debug("No recent activity, skipping prediction"),[];if(o&&r.domains[o]){const u=r.domains[o].languages.map(d=>({language:d.language,score:ue(d,n)}));u.sort((d,p)=>p.score-d.score);for(const d of u.slice(0,W)){if(d.language===s)continue;const p=u[0]?.score||1,c=Math.min(1,d.score/p);l.push({sourceLang:d.language,targetLang:s,confidence:c,domain:o})}}if(l.length<W){const i=new Map;for(const c of Object.values(r.domains))if(c.domain!==o)for(const f of c.languages){if(f.language===s)continue;const N=ue(f,n)*.5,K=i.get(f.language)||0;i.set(f.language,K+N)}const u=Array.from(i.entries()).sort((c,f)=>f[1]-c[1]).filter(([c])=>!l.some(f=>f.sourceLang===c)),d=W-l.length,p=u[0]?.[1]||1;for(const[c,f]of u.slice(0,d))l.push({sourceLang:c,targetLang:s,confidence:Math.min(1,f/p)*.5})}return v.debug(`Predictions for ${o}: ${l.map(i=>`${i.sourceLang}->${i.targetLang}(${i.confidence.toFixed(2)})`).join(", ")}`),l}async getStats(){const t=await this.ensureLoaded(),r=Date.now();A(t,r);const o=Object.values(t.domains).sort((n,s)=>s.totalDetections-n.totalDetections).slice(0,5).map(n=>({domain:n.domain,detections:n.totalDetections}));return{domainCount:Object.keys(t.domains).length,totalTranslations:t.totalTranslations,recentTranslations:t.recentTranslations,preferredTarget:t.preferredTarget,topDomains:o}}async clear(){this.data=Y(),await k({[_]:this.data}),v.info("Prediction data cleared")}}let X=null;function $e(){return X||(X=new Me),X}const D=I("History"),F="translationHistory",xe=20;function De(){return`${Date.now()}-${Math.random().toString(36).substring(2,9)}`}async function fe(){try{return(await te.storage.local.get(F))[F]||[]}catch(e){return D.error("Failed to get history:",e),[]}}async function Pe(e,t,r,o){if(!e||!t||e.trim().length<2)return;const n=500,s=e.length>n?e.substring(0,n)+"...":e,l=t.length>n?t.substring(0,n)+"...":t;try{const i=await fe(),u=i.findIndex(p=>p.sourceText===s&&p.sourceLang===r&&p.targetLang===o);u!==-1&&i.splice(u,1);const d={id:De(),sourceText:s,translatedText:l,sourceLang:r,targetLang:o,timestamp:Date.now()};for(i.unshift(d);i.length>xe;)i.pop();await te.storage.local.set({[F]:i}),D.info("Added to history:",s.substring(0,30)+"...")}catch(i){D.error("Failed to add to history:",i)}}async function _e(){try{await te.storage.local.remove(F),D.info("History cleared")}catch(e){D.error("Failed to clear history:",e)}}const w=I("Corrections"),x="translationCorrections",Ae=500;let C=null;function U(e,t,r){return`${t}:${r}:${e.toLowerCase().trim()}`}async function $(){if(C)return C;try{const e=await chrome.storage.local.get(x);if(e[x]){const t=e[x];Array.isArray(t)?C=new Map(t):C=new Map(Object.entries(t)),w.info(`Loaded ${C.size} corrections`)}else C=new Map}catch(e){w.error("Failed to load corrections:",e),C=new Map}return C}async function B(){if(C)try{const e=Array.from(C.entries());await chrome.storage.local.set({[x]:e}),w.debug(`Saved ${e.length} corrections`)}catch(e){w.error("Failed to save corrections:",e)}}async function Re(e,t,r,o,n){if(!e?.trim()||!r?.trim()){w.warn("Invalid correction: empty original or correction");return}if(r.trim()===t.trim()){w.debug("Skipping correction: same as machine translation");return}const s=await $(),l=U(e,o,n),i=s.get(l);if(i)i.userCorrection=r,i.machineTranslation=t,i.timestamp=Date.now(),i.useCount++,w.debug(`Updated correction (used ${i.useCount}x): "${e.substring(0,30)}..."`);else{if(s.size>=Ae){let u=null,d=Date.now();for(const[p,c]of s)c.timestamp<d&&(d=c.timestamp,u=p);u&&(s.delete(u),w.debug("Evicted oldest correction to make room"))}s.set(l,{original:e,machineTranslation:t,userCorrection:r,sourceLang:o,targetLang:n,timestamp:Date.now(),useCount:1}),w.info(`Correction saved: "${e.substring(0,30)}..." -> "${r.substring(0,30)}..."`)}await B()}async function he(e,t,r){const o=await $(),n=U(e,t,r),s=o.get(n);return s?(s.useCount++,s.timestamp=Date.now(),B().catch(()=>{}),w.debug(`Using saved correction (${s.useCount}x): "${e.substring(0,30)}..."`),s.userCorrection):null}async function pe(){const e=await $();return Array.from(e.values()).sort((t,r)=>r.timestamp-t.timestamp)}async function Fe(){C=new Map,await chrome.storage.local.remove(x),w.info("Corrections cleared")}async function Oe(e,t,r){const o=await $(),n=U(e,t,r);return o.has(n)?(o.delete(n),await B(),w.info(`Deleted correction for: "${e.substring(0,30)}..."`),!0):!1}async function Ie(){const e=await $(),t=Array.from(e.values());return{total:t.length,totalUses:t.reduce((r,o)=>r+o.useCount,0),topCorrections:t.sort((r,o)=>o.useCount-r.useCount).slice(0,10).map(r=>({original:r.original,correction:r.userCorrection,useCount:r.useCount}))}}async function Ue(){const e=await pe();return JSON.stringify(e,null,2)}async function Be(e){try{const t=JSON.parse(e);if(!Array.isArray(t))throw new Error("Invalid format: expected array of corrections");for(const n of t)if(typeof n.original!="string"||typeof n.userCorrection!="string"||typeof n.sourceLang!="string"||typeof n.targetLang!="string")throw new Error("Invalid correction entry: missing required fields");const r=await $();let o=0;for(const n of t){const s=U(n.original,n.sourceLang,n.targetLang);r.set(s,{original:n.original,machineTranslation:n.machineTranslation||"",userCorrection:n.userCorrection,sourceLang:n.sourceLang,targetLang:n.targetLang,timestamp:n.timestamp||Date.now(),useCount:n.useCount||1}),o++}return await B(),w.info(`Imported ${o} corrections`),o}catch(t){throw w.error("Failed to import corrections:",t),t}}const a=I("Background"),y=new Map;let S=0,E=0,J=!1,V=null;async function me(){if(!J)try{const e=await chrome.storage.local.get([h.cache.storageKey,"cacheStats"]);if(e[h.cache.storageKey]&&(e[h.cache.storageKey].forEach(([r,o])=>{y.set(r,o)}),a.info(`Loaded ${y.size} cached translations from storage`)),e.cacheStats){const t=e.cacheStats;S=t.hits||0,E=t.misses||0}J=!0}catch(e){a.warn("Failed to load persistent cache:",e),J=!0}}function ye(){V||(V=setTimeout(async()=>{V=null;try{const e=Array.from(y.entries());await chrome.storage.local.set({[h.cache.storageKey]:e,cacheStats:{hits:S,misses:E}}),a.debug(`Saved ${e.length} translations to persistent storage`)}catch(e){a.warn("Failed to save cache:",e)}},h.cache.saveDebounceMs))}function Ne(e,t,r,o){return be(e,t,r,o||m)}function Ke(e){const t=y.get(e);return t?(t.useCount++,y.delete(e),y.set(e,t),S++,ye(),a.debug(`Cache HIT: ${e.substring(0,40)}... (used ${t.useCount}x)`)):E++,t}function Z(e,t,r,o){for(;y.size>=h.cache.maxSize;){const n=Array.from(y.entries()),s=Math.max(10,Math.floor(n.length*.1)),i=n.slice(0,s).reduce((u,d)=>d[1].useCount<u[1].useCount?d:u);y.delete(i[0]),a.debug(`Cache evicted: ${i[0].substring(0,40)}... (used ${i[1].useCount}x)`)}y.set(e,{result:t,timestamp:Date.now(),sourceLang:r,targetLang:o,useCount:1}),ye(),a.debug(`Cached translation (${y.size}/${h.cache.maxSize})`)}function we(){const e=Array.from(y.entries());let t=null;for(const[,i]of e)(t===null||i.timestamp<t)&&(t=i.timestamp);const r=e.sort((i,u)=>u[1].useCount-i[1].useCount).slice(0,5).map(([i,u])=>({text:i.substring(0,50)+(i.length>50?"...":""),useCount:u.useCount,langs:`${u.sourceLang} -> ${u.targetLang}`})),o={};for(const[,i]of e){const u=`${i.sourceLang}-${i.targetLang}`;o[u]=(o[u]||0)+1}const n=e.reduce((i,[u,d])=>{const p=Array.isArray(d.result)?d.result.join("").length:d.result.length;return i+u.length+p},0),s=S+E,l=s>0?Math.round(S/s*100):0;return{size:y.size,maxSize:h.cache.maxSize,hitRate:`${S}/${s} (${l}%)`,totalHits:S,totalMisses:E,oldestEntry:t,mostUsed:r,memoryEstimate:`~${Math.round(n/1024)}KB`,languagePairs:o}}async function qe(){y.clear(),S=0,E=0;try{await chrome.storage.local.remove([h.cache.storageKey,"cacheStats"]),a.info("Translation cache cleared")}catch(e){a.warn("Failed to clear persistent cache:",e)}}me();const M=$e(),le=new Set;async function Ge(e){try{if(!await M.hasRecentActivity()){a.debug("No recent activity, skipping predictive preload");return}const r=await M.predict(e);if(r.length===0)return;a.info(`Predictive preload: ${r.length} candidates for ${e}`);for(const o of r){const n=`${o.sourceLang}-${o.targetLang}`;if(le.has(n)){a.debug(`Model ${n} already preloaded`);continue}if(o.confidence<.3){a.debug(`Skipping low confidence prediction: ${n} (${o.confidence.toFixed(2)})`);continue}a.info(`Preloading predicted model: ${n} (confidence: ${o.confidence.toFixed(2)})`),b({type:"preloadModel",sourceLang:o.sourceLang,targetLang:o.targetLang,provider:m,priority:"low"}).then(s=>{s.preloaded&&(le.add(n),a.info(`Predictive preload complete: ${n}`))}).catch(s=>{a.warn(`Predictive preload failed for ${n}:`,s)})}}catch(t){a.warn("Predictive preload error:",t)}}async function ze(e,t){try{await M.recordDetection(e,t)}catch(r){a.warn("Failed to record language detection:",r)}}async function He(e){try{await M.recordTranslation(e)}catch(t){a.warn("Failed to record translation:",t)}}let T=null,R=0;const je={maxRetries:h.retry.network.maxRetries,baseDelayMs:h.retry.network.baseDelayMs,maxDelayMs:h.retry.network.maxDelayMs},We={maxRetries:h.retry.offscreen.maxRetries,baseDelayMs:h.retry.offscreen.baseDelayMs,maxDelayMs:h.retry.offscreen.maxDelayMs};async function re(){if(T){await T;return}const e=chrome.runtime.getURL("src/offscreen/offscreen.html");try{if((await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[e]})).length>0){R=0;return}if(T){await T;return}console.log("[Background] Creating offscreen document..."),T=chrome.offscreen.createDocument({url:e,reasons:[chrome.offscreen.Reason.WORKERS],justification:"Run Transformers.js ML inference in document context"}),await T,T=null,R=0,console.log("[Background] Offscreen document created successfully")}catch(t){T=null,R++;const r=t instanceof Error?t.message:String(t);throw a.error(" Failed to create offscreen document:",r),R>=h.retry.maxOffscreenFailures?new Error("Translation engine failed to start. Please reload the extension or restart Chrome."):new Error(`Failed to initialize translation engine: ${r}`)}}async function Ye(){try{const e=chrome.runtime.getURL("src/offscreen/offscreen.html");(await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[e]})).length>0&&(await chrome.offscreen.closeDocument(),console.log("[Background] Closed existing offscreen document"))}catch(e){a.warn(" Error closing offscreen document:",e)}T=null,await new Promise(e=>setTimeout(e,500)),await re()}async function b(e,t=h.timeouts.offscreenMs){return ge(async()=>(await re(),new Promise((r,o)=>{const n=setTimeout(()=>{o(new Error("Offscreen communication timeout"))},t);try{chrome.runtime.sendMessage({...e,target:"offscreen"},s=>{if(clearTimeout(n),chrome.runtime.lastError){o(new Error(chrome.runtime.lastError.message));return}if(s===void 0){o(new Error("No response from translation engine"));return}r(s)})}catch(s){clearTimeout(n),o(s)}})),We,r=>r.retryable?(r.technicalDetails.includes("offscreen")&&(console.log("[Background] Attempting offscreen document reset..."),Ye().catch(console.error)),!0):!1)}let Q="smart",m="opus-mt";const L={requests:0,tokens:0,windowStart:Date.now()};function Xe(e){const t=Date.now();return t-L.windowStart>h.rateLimits.windowMs&&(L.requests=0,L.tokens=0,L.windowStart=t),!(L.requests>=h.rateLimits.requestsPerMinute||L.tokens+e>h.rateLimits.tokensPerMinute)}function Je(e){L.requests++,L.tokens+=e}function Ve(e){const t=Array.isArray(e)?e.join(" "):e;return Math.max(1,Math.ceil(t.length/4))}function ee(e){let t=e.message;return e.suggestion&&(t+=`. ${e.suggestion}`),t}chrome.runtime.onMessage.addListener((e,t,r)=>"target"in e&&e.target==="offscreen"?!1:(Ze(e).then(r).catch(o=>{const n=de(o);a.error(" Error:",n.technicalDetails),r({success:!1,error:ee(n)})}),!0));async function Ze(e){switch(e.type){case"ping":return{success:!0,status:"ready",provider:m};case"translate":return lt(e);case"getUsage":return dt();case"getProviders":return bt();case"preloadModel":return et(e);case"setProvider":return Qe(e);case"getCacheStats":return tt();case"clearCache":return rt();case"checkChromeTranslator":return nt();case"getPredictionStats":return ot();case"recordLanguageDetection":return at(e);case"getCloudProviderStatus":return st();case"setCloudApiKey":return it(e);case"clearCloudApiKey":return ct(e);case"getCloudProviderUsage":return ut(e);case"getProfilingStats":return gt();case"clearProfilingStats":return ft();case"getHistory":return ht();case"clearHistory":return pt();case"addCorrection":return mt(e);case"getCorrection":return yt(e);case"getAllCorrections":return wt();case"getCorrectionStats":return Ct();case"clearCorrections":return vt();case"deleteCorrection":return Lt(e);case"exportCorrections":return Tt();case"importCorrections":return St(e);case"ocrImage":return Et(e);case"getDownloadedModels":try{return{success:!0,models:(await chrome.storage.local.get(["downloadedModels"])).downloadedModels||[]}}catch{return{success:!0,models:[]}}case"getSettings":try{const t=await chrome.storage.local.get(["sourceLanguage","targetLanguage","provider","strategy"]);return{success:!0,data:{sourceLanguage:t.sourceLanguage||"auto",targetLanguage:t.targetLanguage||"en",provider:t.provider||"opus-mt",strategy:t.strategy||"smart"}}}catch{return{success:!1,error:"Failed to get settings"}}default:return console.warn(`[Background] Unknown message type: ${e.type}`),{success:!1,error:`Unknown message type: ${e.type}`}}}async function Qe(e){return m=e.provider,a.info(` Provider set to: ${m}`),await k({provider:m}),{success:!0,provider:m}}async function et(e){const t=e.provider||m;a.info(` Preloading ${t} model: ${e.sourceLang} -> ${e.targetLang}`);try{return await b({type:"preloadModel",sourceLang:e.sourceLang,targetLang:e.targetLang,provider:t})}catch(r){return a.warn(" Preload failed:",r),{success:!1,error:r instanceof Error?r.message:String(r)}}}async function tt(){return await me(),{success:!0,cache:we()}}async function rt(){const e=y.size;return await qe(),{success:!0,clearedEntries:e}}async function nt(){try{return{success:!0,available:(await b({type:"checkChromeTranslator"}))?.available??!1}}catch(e){return a.warn(" Chrome Translator check failed:",e),{success:!0,available:!1}}}async function ot(){try{return{success:!0,prediction:await M.getStats()}}catch(e){return a.warn("Failed to get prediction stats:",e),{success:!1,error:e instanceof Error?e.message:String(e)}}}async function at(e){return await ze(e.url,e.language),{success:!0}}const O={deepl:"deepl_api_key",openai:"openai_api_key",anthropic:"anthropic_api_key","google-cloud":"google_cloud_api_key"};async function st(){try{const e=Object.values(O),t=await P(e),r={};for(const[o,n]of Object.entries(O))r[o]=!!t[n];return{success:!0,status:r}}catch(e){return a.warn("Failed to get cloud provider status:",e),{success:!1,error:e instanceof Error?e.message:String(e),status:{}}}}async function it(e){const t=O[e.provider];if(!t)return{success:!1,error:`Unknown provider: ${e.provider}`};try{const r={[t]:e.apiKey};return e.provider==="deepl"&&e.options?(e.options.isPro!==void 0&&(r.deepl_is_pro=e.options.isPro),e.options.formality!==void 0&&(r.deepl_formality=e.options.formality)):e.provider==="openai"&&e.options?(e.options.model!==void 0&&(r.openai_model=e.options.model),e.options.formality!==void 0&&(r.openai_formality=e.options.formality)):e.provider==="anthropic"&&e.options&&(e.options.model!==void 0&&(r.anthropic_model=e.options.model),e.options.formality!==void 0&&(r.anthropic_formality=e.options.formality)),await k(r),a.info(` API key set for ${e.provider}`),{success:!0,provider:e.provider}}catch(r){return a.error(" Failed to set API key:",r),{success:!1,error:r instanceof Error?r.message:String(r)}}}async function ct(e){const t=O[e.provider];if(!t)return{success:!1,error:`Unknown provider: ${e.provider}`};try{const r=[t];return e.provider==="deepl"?r.push("deepl_is_pro","deepl_formality"):e.provider==="openai"?r.push("openai_model","openai_formality","openai_temperature","openai_tokens_used"):e.provider==="anthropic"?r.push("anthropic_model","anthropic_formality","anthropic_tokens_used"):e.provider==="google-cloud"&&r.push("google_cloud_chars_used"),await chrome.storage.local.remove(r),a.info(` API key cleared for ${e.provider}`),{success:!0,provider:e.provider}}catch(r){return a.error(" Failed to clear API key:",r),{success:!1,error:r instanceof Error?r.message:String(r)}}}async function ut(e){try{return await b({type:"getCloudProviderUsage",provider:e.provider})}catch(t){return a.warn(" Failed to get cloud provider usage:",t),{success:!1,error:t instanceof Error?t.message:String(t)}}}async function lt(e){const t=Date.now();if(e.options?.context){const{before:o,after:n}=e.options.context;a.debug("Translation context:",{before:o?.substring(0,50),after:n?.substring(0,50)})}const r=e.enableProfiling?g.startSession():void 0;r&&(g.startTiming(r,"total"),g.startTiming(r,"validation"));try{const o=Le(e.text,e.sourceLang,e.targetLang);if(r&&g.endTiming(r,"validation"),!o.valid)return{success:!1,error:ee(o.error),duration:Date.now()-t};const n=o.sanitizedText;e.options?.strategy&&(Q=e.options.strategy);const s=e.provider||m;r&&g.startTiming(r,"cache_lookup");const l=Ne(n,e.sourceLang,e.targetLang,s);if(e.sourceLang!=="auto"){const c=Ke(l);if(r&&g.endTiming(r,"cache_lookup"),c){S++;const f=Date.now()-t;return a.info(` Cache hit, returning in ${f}ms`),r&&g.endTiming(r,"total"),{success:!0,result:c.result,duration:f,cached:!0}}}else r&&g.endTiming(r,"cache_lookup");if(E++,typeof n=="string"&&e.sourceLang!=="auto"){const c=await he(n,e.sourceLang,e.targetLang);if(c){const f=Date.now()-t;return a.info(`Using user correction, returning in ${f}ms`),r&&g.endTiming(r,"total"),Z(l,c,e.sourceLang,e.targetLang),{success:!0,result:c,duration:f,fromCorrection:!0}}}const i=Ve(n);if(!Xe(i))return{success:!1,error:"Too many requests. Please wait a moment and try again.",duration:Date.now()-t};if(console.log("[Background] Translating:",e.sourceLang,"->",e.targetLang),s==="chrome-builtin"){r&&g.startTiming(r,"chrome_builtin_translate");try{const f=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0]?.id;if(!f)throw new Error("No active tab for Chrome Translator");const N=Array.isArray(n)?n:[n],K=await chrome.scripting.executeScript({target:{tabId:f},world:"MAIN",func:async(ve,G,z)=>{const H=self.Translator;if(!H)throw new Error("Chrome Translator API not available (requires Chrome 138+)");if((await H.availability({sourceLanguage:G,targetLanguage:z})).available==="no")throw new Error(`Language pair not supported: ${G}-${z}`);const oe=await H.create({sourceLanguage:G,targetLanguage:z}),ae=[];for(const j of ve)ae.push(j.trim()?await oe.translate(j):j);return oe.destroy(),ae},args:[N,e.sourceLang,e.targetLang]});r&&g.endTiming(r,"chrome_builtin_translate");const q=K[0]?.result;if(!q)throw new Error("Chrome Translator returned no result");const ne=Array.isArray(n)?q:q[0],Ce=Date.now()-t;return Z(l,ne,e.sourceLang,e.targetLang),r&&g.endTiming(r,"total"),{success:!0,result:ne,duration:Ce,provider:"chrome-builtin"}}catch(c){r&&g.endTiming(r,"total");const f=c instanceof Error?c.message:String(c);return a.error("Chrome Built-in translation failed:",f),{success:!1,error:f,duration:Date.now()-t}}}r&&g.startTiming(r,"ipc_background_to_offscreen");const u=await ge(async()=>{const c=await b({type:"translate",text:n,sourceLang:e.sourceLang,targetLang:e.targetLang,provider:s,sessionId:r});if(!c)throw new Error("No response from translation engine");if(!c.success){const f=typeof c.error=="string"?c.error:c.error instanceof Error?c.error.message:JSON.stringify(c.error)||"Translation failed";throw new Error(f)}return c},je,c=>Te(c.technicalDetails));r&&(g.endTiming(r,"ipc_background_to_offscreen"),u.profilingData&&g.importSessionData(u.profilingData)),console.log("[Background] Translation complete"),Je(i),r&&g.startTiming(r,"cache_store");const d=e.sourceLang==="auto"?"auto":e.sourceLang;u.result&&d!=="auto"&&Z(l,u.result,d,e.targetLang),r&&(g.endTiming(r,"cache_store"),g.endTiming(r,"total")),He(e.targetLang).catch(()=>{}),u.result&&typeof n=="string"&&typeof u.result=="string"&&Pe(n,u.result,e.sourceLang,e.targetLang).catch(()=>{});let p;if(r){const c=g.getReport(r);c&&(p=c,console.log(g.formatReport(r)))}return{success:!0,result:u.result,duration:Date.now()-t,profilingReport:p}}catch(o){r&&g.endTiming(r,"total");const n=de(o);return a.error(" Translation error:",n.technicalDetails),{success:!1,error:ee(n),duration:Date.now()-t}}}function dt(){return{throttle:{requests:L.requests,tokens:L.tokens,requestLimit:h.rateLimits.requestsPerMinute,tokenLimit:h.rateLimits.tokensPerMinute,queue:0},cache:we(),providers:{}}}async function gt(){try{const e=g.getAllAggregates();let t={};try{const o=await b({type:"getProfilingStats"});o?.success&&o.aggregates&&(t=o.aggregates)}catch{}return{success:!0,aggregates:{...e,...t},formatted:g.formatAggregates()}}catch(e){return a.warn("Failed to get profiling stats:",e),{success:!1,error:e instanceof Error?e.message:String(e)}}}function ft(){return g.clear(),a.info("Profiling stats cleared"),{success:!0}}async function ht(){try{return{success:!0,history:await fe()}}catch(e){return a.warn("Failed to get history:",e),{success:!1,error:e instanceof Error?e.message:String(e),history:[]}}}async function pt(){try{return await _e(),{success:!0}}catch(e){return a.warn("Failed to clear history:",e),{success:!1,error:e instanceof Error?e.message:String(e)}}}async function mt(e){try{return await Re(e.original,e.machineTranslation,e.userCorrection,e.sourceLang,e.targetLang),{success:!0}}catch(t){return a.warn("Failed to add correction:",t),{success:!1,error:t instanceof Error?t.message:String(t)}}}async function yt(e){try{const t=await he(e.original,e.sourceLang,e.targetLang);return{success:!0,correction:t,hasCorrection:t!==null}}catch(t){return a.warn("Failed to get correction:",t),{success:!1,error:t instanceof Error?t.message:String(t),correction:null,hasCorrection:!1}}}async function wt(){try{return{success:!0,corrections:await pe()}}catch(e){return a.warn("Failed to get corrections:",e),{success:!1,error:e instanceof Error?e.message:String(e),corrections:[]}}}async function Ct(){try{return{success:!0,stats:await Ie()}}catch(e){return a.warn("Failed to get correction stats:",e),{success:!1,error:e instanceof Error?e.message:String(e),stats:{total:0,totalUses:0,topCorrections:[]}}}}async function vt(){try{return await Fe(),{success:!0}}catch(e){return a.warn("Failed to clear corrections:",e),{success:!1,error:e instanceof Error?e.message:String(e)}}}async function Lt(e){try{return{success:!0,deleted:await Oe(e.original,e.sourceLang,e.targetLang)}}catch(t){return a.warn("Failed to delete correction:",t),{success:!1,error:t instanceof Error?t.message:String(t),deleted:!1}}}async function Tt(){try{return{success:!0,json:await Ue()}}catch(e){return a.warn("Failed to export corrections:",e),{success:!1,error:e instanceof Error?e.message:String(e)}}}async function St(e){try{return{success:!0,importedCount:await Be(e.json)}}catch(t){return a.warn("Failed to import corrections:",t),{success:!1,error:t instanceof Error?t.message:String(t),importedCount:0}}}async function bt(){try{const e=await b({type:"getSupportedLanguages"});return{providers:[{id:"opus-mt",name:"Helsinki-NLP OPUS-MT",type:"local",qualityTier:"standard",description:"Fast, lightweight (~170MB per pair)",icon:""},{id:"translategemma",name:"TranslateGemma 4B",type:"local",qualityTier:"premium",description:"High quality, single model (~3.6GB)",icon:""}],activeProvider:m,strategy:Q,supportedLanguages:e.success?e.languages:[]}}catch(e){return a.warn(" Error getting providers:",e),{providers:[{id:"opus-mt",name:"Helsinki-NLP OPUS-MT",type:"local",qualityTier:"standard",description:"Fast, lightweight (~170MB per pair)",icon:""},{id:"translategemma",name:"TranslateGemma 4B",type:"local",qualityTier:"premium",description:"High quality, single model (~3.6GB)",icon:""}],activeProvider:m,strategy:Q,supportedLanguages:[],error:"Could not load language list. Translation may still work."}}}chrome.action.onClicked.addListener(async e=>{e.id&&console.log("[Background] Extension icon clicked for tab:",e.id)});async function Et(e){try{a.info("Processing OCR request...");const t=await b({type:"ocrImage",imageData:e.imageData,lang:e.lang});return t.success&&a.info(`OCR completed: ${t.blocks?.length||0} blocks, ${t.confidence?.toFixed(1)}% confidence`),t}catch(t){return a.error("OCR failed:",t),{success:!1,error:t instanceof Error?t.message:String(t)}}}function kt(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"translate-selection",title:"Translate Selection",contexts:["selection"]}),chrome.contextMenus.create({id:"translate-page",title:"Translate Page",contexts:["page"]}),chrome.contextMenus.create({id:"separator",type:"separator",contexts:["page","selection"]}),chrome.contextMenus.create({id:"undo-translation",title:"Undo Translation",contexts:["page"]}),chrome.contextMenus.create({id:"translate-image",title:"Translate Image Text",contexts:["image"]}),a.info("Context menus created")})}chrome.contextMenus.onClicked.addListener(async(e,t)=>{if(!t?.id)return;const r=await P(["sourceLang","targetLang","strategy","provider"]),o=r.sourceLang||"auto",n=r.targetLang||"en",s=r.strategy||"smart",l=r.provider||"opus-mt";try{switch(e.menuItemId){case"translate-selection":await chrome.tabs.sendMessage(t.id,{type:"translateSelection",sourceLang:o,targetLang:n,strategy:s,provider:l});break;case"translate-page":await chrome.tabs.sendMessage(t.id,{type:"translatePage",sourceLang:o,targetLang:n,strategy:s,provider:l});break;case"undo-translation":await chrome.tabs.sendMessage(t.id,{type:"undoTranslation"});break;case"translate-image":await chrome.tabs.sendMessage(t.id,{type:"translateImage",imageUrl:e.srcUrl,sourceLang:o,targetLang:n,provider:l});break}}catch(i){a.warn("Context menu action failed:",i)}});chrome.commands.onCommand.addListener(async(e,t)=>{if(console.log("[Background] Command received:",e),!t?.id)return;const r=await P(["sourceLang","targetLang","strategy","provider"]),o=r.sourceLang||"auto",n=r.targetLang||"en",s=r.strategy||"smart",l=r.provider||m;try{switch(e){case"translate-page":await chrome.tabs.sendMessage(t.id,{type:"translatePage",sourceLang:o,targetLang:n,strategy:s,provider:l});break;case"translate-selection":await chrome.tabs.sendMessage(t.id,{type:"translateSelection",sourceLang:o,targetLang:n,strategy:s,provider:l});break;case"undo-translation":await chrome.tabs.sendMessage(t.id,{type:"undoTranslation"});break;case"toggle-widget":await chrome.tabs.sendMessage(t.id,{type:"toggleWidget"});break}}catch(i){a.warn("Keyboard shortcut action failed:",i)}});chrome.tabs.onUpdated.addListener((e,t,r)=>{t.status==="complete"&&r.url&&!r.url.startsWith("chrome://")&&(a.debug(`Tab updated: ${r.url}`),Ge(r.url).catch(o=>{a.warn("Predictive preload trigger failed:",o)}))});chrome.runtime.onInstalled.addListener(async e=>{if(kt(),e.reason==="install"){console.log("[Background] Extension installed");const{onboardingComplete:t}=await chrome.storage.local.get("onboardingComplete");t||(console.log("[Background] Opening onboarding page"),chrome.tabs.create({url:chrome.runtime.getURL("src/onboarding/index.html")}));const r=chrome.i18n.getUILanguage().split("-")[0];console.log("[Background] Browser language detected:",r),k({sourceLang:"auto",targetLang:r||"en",strategy:"smart",provider:"opus-mt"})}else e.reason==="update"&&console.log("[Background] Extension updated from",e.previousVersion)});(async()=>{const e=await P(["provider"]);e.provider&&(m=e.provider,console.log("[Background] Restored provider:",m));try{if(m==="opus-mt"){const r=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0]?.id;r&&(await chrome.scripting.executeScript({target:{tabId:r},world:"MAIN",func:()=>typeof self.Translator<"u"}))[0]?.result===!0&&(m="chrome-builtin",await k({provider:"chrome-builtin"}),console.log("[Background] Auto-detected Chrome Built-in Translator, setting as default"))}}catch(t){a.debug("Chrome Built-in auto-detection skipped:",t)}})();chrome.runtime.onStartup.addListener(()=>{console.log("[Background] Extension startup, pre-warming offscreen document..."),re().catch(e=>{a.warn(" Pre-warm failed (will retry on first use):",e)})});(async()=>{try{await M.load(),console.log("[Background] Prediction engine initialized")}catch(e){a.warn("Failed to initialize prediction engine:",e)}})();console.log("[Background] Service worker initialized v2.3 with predictive model preloading");
//# sourceMappingURL=background.js.map
