import{c as q,p as c,v as Y,w as G,i as V}from"./assets/errors-BaG1msl8.js";import{c as z}from"./assets/logger-B_opVjnm.js";import{a as F,s as P}from"./assets/storage-Ddu9hF13.js";import{C as d}from"./assets/config-CjpLU7Kz.js";function X(e){let r=2166136261;for(let t=0;t<e.length;t++)r^=e.charCodeAt(t),r=Math.imul(r,16777619);return(r>>>0).toString(16).padStart(8,"0")}function J(e,r,t,n){const o=Array.isArray(e)?e.join("|||"):e,i=X(o);return`${n}:${r}-${t}:${i}`}const y=z("PredictionEngine"),U=100,$=3,Q=7*24*60*60*1e3,N=1,C="predictionData";function R(){return{domains:{},preferredTarget:"en",totalTranslations:0,lastTranslation:0,recentTranslations:0,recentWindowStart:Date.now()}}function B(e){try{return new URL(e).hostname}catch{return null}}function I(e,r){const t=r-e.lastSeen,n=Math.pow(.5,t/Q);return e.count*n}function Z(e){const r=Object.values(e.domains);if(r.length<=U)return;r.sort((n,o)=>n.lastSeen-o.lastSeen);const t=r.length-U;for(let n=0;n<t;n++){const o=r[n].domain;delete e.domains[o],y.debug(`Evicted LRU domain: ${o}`)}}function _(e,r){r-e.recentWindowStart>864e5&&(e.recentTranslations=0,e.recentWindowStart=r)}class ee{data=null;saveTimeout=null;async load(){try{const r=await F([C]);this.data=r[C]||R(),y.info(`Loaded prediction data: ${Object.keys(this.data.domains).length} domains`)}catch(r){y.warn("Failed to load prediction data:",r),this.data=R()}}async save(){this.saveTimeout&&clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(async()=>{this.data&&await P({[C]:this.data})&&y.debug("Prediction data saved")},1e3)}async ensureLoaded(){return this.data||await this.load(),this.data}async recordDetection(r,t){const n=await this.ensureLoaded(),o=B(r);if(!o){y.warn("Could not extract domain from URL:",r);return}const i=Date.now();n.domains[o]||(n.domains[o]={domain:o,languages:[],totalDetections:0,firstSeen:i,lastSeen:i});const u=n.domains[o];u.lastSeen=i,u.totalDetections++;let l=u.languages.find(g=>g.language===t);l||(l={language:t,count:0,lastSeen:i},u.languages.push(l)),l.count++,l.lastSeen=i,Z(n),y.debug(`Recorded detection: ${o} -> ${t} (count: ${l.count})`),await this.save()}async recordTranslation(r){const t=await this.ensureLoaded(),n=Date.now();_(t,n),t.totalTranslations++,t.lastTranslation=n,t.recentTranslations++,t.preferredTarget=r,y.debug(`Recorded translation: target=${r}, recent=${t.recentTranslations}`),await this.save()}async setPreferredTarget(r){const t=await this.ensureLoaded();t.preferredTarget=r,await this.save()}async getPreferredTarget(){return(await this.ensureLoaded()).preferredTarget}async hasRecentActivity(){const r=await this.ensureLoaded(),t=Date.now();return _(r,t),r.recentTranslations>=N}async predict(r){const t=await this.ensureLoaded(),n=B(r),o=Date.now(),i=t.preferredTarget,u=[];if(_(t,o),t.recentTranslations<N)return y.debug("No recent activity, skipping prediction"),[];if(n&&t.domains[n]){const g=t.domains[n].languages.map(p=>({language:p.language,score:I(p,o)}));g.sort((p,v)=>v.score-p.score);for(const p of g.slice(0,$)){if(p.language===i)continue;const v=g[0]?.score||1,s=Math.min(1,p.score/v);u.push({sourceLang:p.language,targetLang:i,confidence:s,domain:n})}}if(u.length<$){const l=new Map;for(const s of Object.values(t.domains))if(s.domain!==n)for(const f of s.languages){if(f.language===i)continue;const H=I(f,o)*.5,W=l.get(f.language)||0;l.set(f.language,W+H)}const g=Array.from(l.entries()).sort((s,f)=>f[1]-s[1]).filter(([s])=>!u.some(f=>f.sourceLang===s)),p=$-u.length,v=g[0]?.[1]||1;for(const[s,f]of g.slice(0,p))u.push({sourceLang:s,targetLang:i,confidence:Math.min(1,f/v)*.5})}return y.debug(`Predictions for ${n}: ${u.map(l=>`${l.sourceLang}->${l.targetLang}(${l.confidence.toFixed(2)})`).join(", ")}`),u}async getStats(){const r=await this.ensureLoaded(),t=Date.now();_(r,t);const n=Object.values(r.domains).sort((o,i)=>i.totalDetections-o.totalDetections).slice(0,5).map(o=>({domain:o.domain,detections:o.totalDetections}));return{domainCount:Object.keys(r.domains).length,totalTranslations:r.totalTranslations,recentTranslations:r.recentTranslations,preferredTarget:r.preferredTarget,topDomains:n}}async clear(){this.data=R(),await P({[C]:this.data}),y.info("Prediction data cleared")}}let x=null;function te(){return x||(x=new ee),x}const a=z("Background"),m=new Map;function re(e,r,t,n){return J(e,r,t,n||h)}function ne(e){const r=m.get(e);return r&&(m.delete(e),m.set(e,r),a.info(` Cache HIT: ${e.substring(0,40)}...`)),r}function oe(e,r,t,n){for(;m.size>=d.cache.maxSize;){const o=m.keys().next().value;o&&(m.delete(o),a.info(" Cache evicted oldest entry"))}m.set(e,{result:r,timestamp:Date.now(),sourceLang:t,targetLang:n}),a.info(` Cached translation (${m.size}/${d.cache.maxSize})`)}function j(){let e=null;for(const r of m.values())(e===null||r.timestamp<e)&&(e=r.timestamp);return{size:m.size,maxSize:d.cache.maxSize,hitRate:`${S}/${S+E} (${S+E>0?Math.round(S/(S+E)*100):0}%)`,oldestEntry:e}}let S=0,E=0;const k=te(),K=new Set;async function ae(e){try{if(!await k.hasRecentActivity()){a.debug("No recent activity, skipping predictive preload");return}const t=await k.predict(e);if(t.length===0)return;a.info(`Predictive preload: ${t.length} candidates for ${e}`);for(const n of t){const o=`${n.sourceLang}-${n.targetLang}`;if(K.has(o)){a.debug(`Model ${o} already preloaded`);continue}if(n.confidence<.3){a.debug(`Skipping low confidence prediction: ${o} (${n.confidence.toFixed(2)})`);continue}a.info(`Preloading predicted model: ${o} (confidence: ${n.confidence.toFixed(2)})`),L({type:"preloadModel",sourceLang:n.sourceLang,targetLang:n.targetLang,provider:h,priority:"low"}).then(i=>{i.preloaded&&(K.add(o),a.info(`Predictive preload complete: ${o}`))}).catch(i=>{a.warn(`Predictive preload failed for ${o}:`,i)})}}catch(r){a.warn("Predictive preload error:",r)}}async function ie(e,r){try{await k.recordDetection(e,r)}catch(t){a.warn("Failed to record language detection:",t)}}async function se(e){try{await k.recordTranslation(e)}catch(r){a.warn("Failed to record translation:",r)}}let T=null,D=0;const ce={maxRetries:d.retry.network.maxRetries,baseDelayMs:d.retry.network.baseDelayMs,maxDelayMs:d.retry.network.maxDelayMs},le={maxRetries:d.retry.offscreen.maxRetries,baseDelayMs:d.retry.offscreen.baseDelayMs,maxDelayMs:d.retry.offscreen.maxDelayMs};async function A(){const e=chrome.runtime.getURL("src/offscreen/offscreen.html");try{if((await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[e]})).length>0){D=0;return}if(T){await T;return}console.log("[Background] Creating offscreen document..."),T=chrome.offscreen.createDocument({url:e,reasons:[chrome.offscreen.Reason.WORKERS],justification:"Run Transformers.js ML inference in document context"}),await T,T=null,D=0,console.log("[Background] Offscreen document created successfully")}catch(r){T=null,D++;const t=r instanceof Error?r.message:String(r);throw a.error(" Failed to create offscreen document:",t),D>=d.retry.maxOffscreenFailures?new Error("Translation engine failed to start. Please reload the extension or restart Chrome."):new Error(`Failed to initialize translation engine: ${t}`)}}async function de(){try{const e=chrome.runtime.getURL("src/offscreen/offscreen.html");(await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[e]})).length>0&&(await chrome.offscreen.closeDocument(),console.log("[Background] Closed existing offscreen document"))}catch(e){a.warn(" Error closing offscreen document:",e)}T=null,await new Promise(e=>setTimeout(e,500)),await A()}async function L(e,r=d.timeouts.offscreenMs){return G(async()=>(await A(),new Promise((t,n)=>{const o=setTimeout(()=>{n(new Error("Offscreen communication timeout"))},r);try{chrome.runtime.sendMessage({...e,target:"offscreen"},i=>{if(clearTimeout(o),chrome.runtime.lastError){n(new Error(chrome.runtime.lastError.message));return}if(i===void 0){n(new Error("No response from translation engine"));return}t(i)})}catch(i){clearTimeout(o),n(i)}})),le,t=>t.retryable?(t.technicalDetails.includes("offscreen")&&(console.log("[Background] Attempting offscreen document reset..."),de().catch(console.error)),!0):!1)}let b="smart",h="opus-mt";const w={requests:0,tokens:0,windowStart:Date.now()};function ue(e){const r=Date.now();return r-w.windowStart>d.rateLimits.windowMs&&(w.requests=0,w.tokens=0,w.windowStart=r),!(w.requests>=d.rateLimits.requestsPerMinute||w.tokens+e>d.rateLimits.tokensPerMinute)}function fe(e){w.requests++,w.tokens+=e}function ge(e){const r=Array.isArray(e)?e.join(" "):e;return Math.max(1,Math.ceil(r.length/4))}function O(e){let r=e.message;return e.suggestion&&(r+=`. ${e.suggestion}`),r}chrome.runtime.onMessage.addListener((e,r,t)=>"target"in e&&e.target==="offscreen"?!1:(pe(e).then(t).catch(n=>{const o=q(n);a.error(" Error:",o.technicalDetails),t({success:!1,error:O(o)})}),!0));async function pe(e){switch(e.type){case"ping":return{success:!0,status:"ready",provider:h};case"translate":return Ce(e);case"getUsage":return _e();case"getProviders":return $e();case"preloadModel":return me(e);case"setProvider":return he(e);case"getCacheStats":return ye();case"clearCache":return we();case"checkChromeTranslator":return ve();case"getPredictionStats":return Te();case"recordLanguageDetection":return Se(e);case"getCloudProviderStatus":return Le();case"setCloudApiKey":return ke(e);case"clearCloudApiKey":return Ee(e);case"getCloudProviderUsage":return Pe(e);case"getProfilingStats":return De();case"clearProfilingStats":return Me();default:throw new Error(`Unknown message type: ${e.type}`)}}async function he(e){return h=e.provider,a.info(` Provider set to: ${h}`),await P({provider:h}),{success:!0,provider:h}}async function me(e){const r=e.provider||h;a.info(` Preloading ${r} model: ${e.sourceLang} -> ${e.targetLang}`);try{return await L({type:"preloadModel",sourceLang:e.sourceLang,targetLang:e.targetLang,provider:r})}catch(t){return a.warn(" Preload failed:",t),{success:!1,error:t instanceof Error?t.message:String(t)}}}function ye(){return{success:!0,cache:j()}}function we(){const e=m.size;return m.clear(),S=0,E=0,a.info(` Cache cleared (was ${e} entries)`),{success:!0,clearedEntries:e}}async function ve(){try{return{success:!0,available:(await L({type:"checkChromeTranslator"}))?.available??!1}}catch(e){return a.warn(" Chrome Translator check failed:",e),{success:!0,available:!1}}}async function Te(){try{return{success:!0,prediction:await k.getStats()}}catch(e){return a.warn("Failed to get prediction stats:",e),{success:!1,error:e instanceof Error?e.message:String(e)}}}async function Se(e){return await ie(e.url,e.language),{success:!0}}const M={deepl:"deepl_api_key",openai:"openai_api_key",anthropic:"anthropic_api_key","google-cloud":"google_cloud_api_key"};async function Le(){try{const e=Object.values(M),r=await F(e),t={};for(const[n,o]of Object.entries(M))t[n]=!!r[o];return{success:!0,status:t}}catch(e){return a.warn("Failed to get cloud provider status:",e),{success:!1,error:e instanceof Error?e.message:String(e),status:{}}}}async function ke(e){const r=M[e.provider];if(!r)return{success:!1,error:`Unknown provider: ${e.provider}`};try{const t={[r]:e.apiKey};return e.provider==="deepl"&&e.options?(e.options.isPro!==void 0&&(t.deepl_is_pro=e.options.isPro),e.options.formality!==void 0&&(t.deepl_formality=e.options.formality)):e.provider==="openai"&&e.options?(e.options.model!==void 0&&(t.openai_model=e.options.model),e.options.formality!==void 0&&(t.openai_formality=e.options.formality)):e.provider==="anthropic"&&e.options&&(e.options.model!==void 0&&(t.anthropic_model=e.options.model),e.options.formality!==void 0&&(t.anthropic_formality=e.options.formality)),await P(t),a.info(` API key set for ${e.provider}`),{success:!0,provider:e.provider}}catch(t){return a.error(" Failed to set API key:",t),{success:!1,error:t instanceof Error?t.message:String(t)}}}async function Ee(e){const r=M[e.provider];if(!r)return{success:!1,error:`Unknown provider: ${e.provider}`};try{const t=[r];return e.provider==="deepl"?t.push("deepl_is_pro","deepl_formality"):e.provider==="openai"?t.push("openai_model","openai_formality","openai_temperature","openai_tokens_used"):e.provider==="anthropic"?t.push("anthropic_model","anthropic_formality","anthropic_tokens_used"):e.provider==="google-cloud"&&t.push("google_cloud_chars_used"),await chrome.storage.local.remove(t),a.info(` API key cleared for ${e.provider}`),{success:!0,provider:e.provider}}catch(t){return a.error(" Failed to clear API key:",t),{success:!1,error:t instanceof Error?t.message:String(t)}}}async function Pe(e){try{return await L({type:"getCloudProviderUsage",provider:e.provider})}catch(r){return a.warn(" Failed to get cloud provider usage:",r),{success:!1,error:r instanceof Error?r.message:String(r)}}}async function Ce(e){const r=Date.now(),t=e.enableProfiling?c.startSession():void 0;t&&(c.startTiming(t,"total"),c.startTiming(t,"validation"));try{const n=Y(e.text,e.sourceLang,e.targetLang);if(t&&c.endTiming(t,"validation"),!n.valid)return{success:!1,error:O(n.error),duration:Date.now()-r};const o=n.sanitizedText;e.options?.strategy&&(b=e.options.strategy);const i=e.provider||h;t&&c.startTiming(t,"cache_lookup");const u=re(o,e.sourceLang,e.targetLang,i);if(e.sourceLang!=="auto"){const s=ne(u);if(t&&c.endTiming(t,"cache_lookup"),s){S++;const f=Date.now()-r;return a.info(` Cache hit, returning in ${f}ms`),t&&c.endTiming(t,"total"),{success:!0,result:s.result,duration:f,cached:!0}}}else t&&c.endTiming(t,"cache_lookup");E++;const l=ge(o);if(!ue(l))return{success:!1,error:"Too many requests. Please wait a moment and try again.",duration:Date.now()-r};console.log("[Background] Translating:",e.sourceLang,"->",e.targetLang),t&&c.startTiming(t,"ipc_background_to_offscreen");const g=await G(async()=>{const s=await L({type:"translate",text:o,sourceLang:e.sourceLang,targetLang:e.targetLang,provider:i,sessionId:t});if(!s)throw new Error("No response from translation engine");if(!s.success){const f=typeof s.error=="string"?s.error:s.error instanceof Error?s.error.message:JSON.stringify(s.error)||"Translation failed";throw new Error(f)}return s},ce,s=>V(s.technicalDetails));t&&(c.endTiming(t,"ipc_background_to_offscreen"),g.profilingData&&c.importSessionData(g.profilingData)),console.log("[Background] Translation complete"),fe(l),t&&c.startTiming(t,"cache_store");const p=e.sourceLang==="auto"?"auto":e.sourceLang;g.result&&p!=="auto"&&oe(u,g.result,p,e.targetLang),t&&(c.endTiming(t,"cache_store"),c.endTiming(t,"total")),se(e.targetLang).catch(()=>{});const v=t?c.getReport(t):void 0;return v&&console.log(c.formatReport(t)),{success:!0,result:g.result,duration:Date.now()-r,profilingReport:v}}catch(n){t&&c.endTiming(t,"total");const o=q(n);return a.error(" Translation error:",o.technicalDetails),{success:!1,error:O(o),duration:Date.now()-r}}}function _e(){return{throttle:{requests:w.requests,tokens:w.tokens,requestLimit:d.rateLimits.requestsPerMinute,tokenLimit:d.rateLimits.tokensPerMinute,queue:0},cache:j(),providers:{}}}async function De(){try{const e=c.getAllAggregates();let r={};try{const n=await L({type:"getProfilingStats"});n?.success&&n.aggregates&&(r=n.aggregates)}catch{}return{success:!0,aggregates:{...e,...r},formatted:c.formatAggregates()}}catch(e){return a.warn("Failed to get profiling stats:",e),{success:!1,error:e instanceof Error?e.message:String(e)}}}function Me(){return c.clear(),a.info("Profiling stats cleared"),{success:!0}}async function $e(){try{const e=await L({type:"getSupportedLanguages"});return{providers:[{id:"opus-mt",name:"Helsinki-NLP OPUS-MT",type:"local",qualityTier:"standard",description:"Fast, lightweight (~170MB per pair)",icon:""},{id:"translategemma",name:"TranslateGemma 4B",type:"local",qualityTier:"premium",description:"High quality, single model (~3.6GB)",icon:""}],activeProvider:h,strategy:b,supportedLanguages:e.success?e.languages:[]}}catch(e){return a.warn(" Error getting providers:",e),{providers:[{id:"opus-mt",name:"Helsinki-NLP OPUS-MT",type:"local",qualityTier:"standard",description:"Fast, lightweight (~170MB per pair)",icon:""},{id:"translategemma",name:"TranslateGemma 4B",type:"local",qualityTier:"premium",description:"High quality, single model (~3.6GB)",icon:""}],activeProvider:h,strategy:b,supportedLanguages:[],error:"Could not load language list. Translation may still work."}}}chrome.action.onClicked.addListener(async e=>{e.id&&console.log("[Background] Extension icon clicked for tab:",e.id)});chrome.tabs.onUpdated.addListener((e,r,t)=>{r.status==="complete"&&t.url&&!t.url.startsWith("chrome://")&&(a.debug(`Tab updated: ${t.url}`),ae(t.url).catch(n=>{a.warn("Predictive preload trigger failed:",n)}))});chrome.runtime.onInstalled.addListener(e=>{if(e.reason==="install"){console.log("[Background] Extension installed");const r=chrome.i18n.getUILanguage().split("-")[0];console.log("[Background] Browser language detected:",r),P({sourceLang:"auto",targetLang:r||"en",strategy:"smart",provider:"opus-mt"})}else e.reason==="update"&&console.log("[Background] Extension updated from",e.previousVersion)});(async()=>{const e=await F(["provider"]);e.provider&&(h=e.provider,console.log("[Background] Restored provider:",h))})();chrome.runtime.onStartup.addListener(()=>{console.log("[Background] Extension startup, pre-warming offscreen document..."),A().catch(e=>{a.warn(" Pre-warm failed (will retry on first use):",e)})});(async()=>{try{await k.load(),console.log("[Background] Prediction engine initialized")}catch(e){a.warn("Failed to initialize prediction engine:",e)}})();console.log("[Background] Service worker initialized v2.3 with predictive model preloading");
//# sourceMappingURL=background.js.map
