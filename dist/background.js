import{c as j,C as f,p as d,v as Z,w as W,i as Q}from"./assets/errors-D38cwdSd.js";import{c as U}from"./assets/logger-B_opVjnm.js";import{a as b,s as _,b as N}from"./assets/storage-Ddu9hF13.js";function ee(e){let r=2166136261;for(let t=0;t<e.length;t++)r^=e.charCodeAt(t),r=Math.imul(r,16777619);return(r>>>0).toString(16).padStart(8,"0")}function te(e,r,t,n){const o=Array.isArray(e)?e.join("|||"):e,i=ee(o);return`${n}:${r}-${t}:${i}`}const w=U("PredictionEngine"),G=100,x=3,re=7*24*60*60*1e3,H=1,P="predictionData";function F(){return{domains:{},preferredTarget:"en",totalTranslations:0,lastTranslation:0,recentTranslations:0,recentWindowStart:Date.now()}}function K(e){try{return new URL(e).hostname}catch{return null}}function q(e,r){const t=r-e.lastSeen,n=Math.pow(.5,t/re);return e.count*n}function ne(e){const r=Object.values(e.domains);if(r.length<=G)return;r.sort((n,o)=>n.lastSeen-o.lastSeen);const t=r.length-G;for(let n=0;n<t;n++){const o=r[n].domain;delete e.domains[o],w.debug(`Evicted LRU domain: ${o}`)}}function D(e,r){r-e.recentWindowStart>864e5&&(e.recentTranslations=0,e.recentWindowStart=r)}class oe{data=null;saveTimeout=null;async load(){try{const r=await b([P]);this.data=r[P]||F(),w.info(`Loaded prediction data: ${Object.keys(this.data.domains).length} domains`)}catch(r){w.warn("Failed to load prediction data:",r),this.data=F()}}async save(){this.saveTimeout&&clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(async()=>{this.data&&await _({[P]:this.data})&&w.debug("Prediction data saved")},1e3)}async ensureLoaded(){return this.data||await this.load(),this.data}async recordDetection(r,t){const n=await this.ensureLoaded(),o=K(r);if(!o){w.warn("Could not extract domain from URL:",r);return}const i=Date.now();n.domains[o]||(n.domains[o]={domain:o,languages:[],totalDetections:0,firstSeen:i,lastSeen:i});const u=n.domains[o];u.lastSeen=i,u.totalDetections++;let s=u.languages.find(l=>l.language===t);s||(s={language:t,count:0,lastSeen:i},u.languages.push(s)),s.count++,s.lastSeen=i,ne(n),w.debug(`Recorded detection: ${o} -> ${t} (count: ${s.count})`),await this.save()}async recordTranslation(r){const t=await this.ensureLoaded(),n=Date.now();D(t,n),t.totalTranslations++,t.lastTranslation=n,t.recentTranslations++,t.preferredTarget=r,w.debug(`Recorded translation: target=${r}, recent=${t.recentTranslations}`),await this.save()}async setPreferredTarget(r){const t=await this.ensureLoaded();t.preferredTarget=r,await this.save()}async getPreferredTarget(){return(await this.ensureLoaded()).preferredTarget}async hasRecentActivity(){const r=await this.ensureLoaded(),t=Date.now();return D(r,t),r.recentTranslations>=H}async predict(r){const t=await this.ensureLoaded(),n=K(r),o=Date.now(),i=t.preferredTarget,u=[];if(D(t,o),t.recentTranslations<H)return w.debug("No recent activity, skipping prediction"),[];if(n&&t.domains[n]){const l=t.domains[n].languages.map(g=>({language:g.language,score:q(g,o)}));l.sort((g,y)=>y.score-g.score);for(const g of l.slice(0,x)){if(g.language===i)continue;const y=l[0]?.score||1,c=Math.min(1,g.score/y);u.push({sourceLang:g.language,targetLang:i,confidence:c,domain:n})}}if(u.length<x){const s=new Map;for(const c of Object.values(t.domains))if(c.domain!==n)for(const p of c.languages){if(p.language===i)continue;const V=q(p,o)*.5,J=s.get(p.language)||0;s.set(p.language,J+V)}const l=Array.from(s.entries()).sort((c,p)=>p[1]-c[1]).filter(([c])=>!u.some(p=>p.sourceLang===c)),g=x-u.length,y=l[0]?.[1]||1;for(const[c,p]of l.slice(0,g))u.push({sourceLang:c,targetLang:i,confidence:Math.min(1,p/y)*.5})}return w.debug(`Predictions for ${n}: ${u.map(s=>`${s.sourceLang}->${s.targetLang}(${s.confidence.toFixed(2)})`).join(", ")}`),u}async getStats(){const r=await this.ensureLoaded(),t=Date.now();D(r,t);const n=Object.values(r.domains).sort((o,i)=>i.totalDetections-o.totalDetections).slice(0,5).map(o=>({domain:o.domain,detections:o.totalDetections}));return{domainCount:Object.keys(r.domains).length,totalTranslations:r.totalTranslations,recentTranslations:r.recentTranslations,preferredTarget:r.preferredTarget,topDomains:n}}async clear(){this.data=F(),await _({[P]:this.data}),w.info("Prediction data cleared")}}let O=null;function ae(){return O||(O=new oe),O}const C=U("History"),$="translationHistory",ie=20;function se(){return`${Date.now()}-${Math.random().toString(36).substring(2,9)}`}async function Y(){try{return(await N.storage.local.get($))[$]||[]}catch(e){return C.error("Failed to get history:",e),[]}}async function ce(e,r,t,n){if(!e||!r||e.trim().length<2)return;const o=500,i=e.length>o?e.substring(0,o)+"...":e,u=r.length>o?r.substring(0,o)+"...":r;try{const s=await Y(),l=s.findIndex(y=>y.sourceText===i&&y.sourceLang===t&&y.targetLang===n);l!==-1&&s.splice(l,1);const g={id:se(),sourceText:i,translatedText:u,sourceLang:t,targetLang:n,timestamp:Date.now()};for(s.unshift(g);s.length>ie;)s.pop();await N.storage.local.set({[$]:s}),C.info("Added to history:",i.substring(0,30)+"...")}catch(s){C.error("Failed to add to history:",s)}}async function le(){try{await N.storage.local.remove($),C.info("History cleared")}catch(e){C.error("Failed to clear history:",e)}}const a=U("Background"),m=new Map;function de(e,r,t,n){return te(e,r,t,n||h)}function ue(e){const r=m.get(e);return r&&(m.delete(e),m.set(e,r),a.info(` Cache HIT: ${e.substring(0,40)}...`)),r}function fe(e,r,t,n){for(;m.size>=f.cache.maxSize;){const o=m.keys().next().value;o&&(m.delete(o),a.info(" Cache evicted oldest entry"))}m.set(e,{result:r,timestamp:Date.now(),sourceLang:t,targetLang:n}),a.info(` Cached translation (${m.size}/${f.cache.maxSize})`)}function X(){let e=null;for(const r of m.values())(e===null||r.timestamp<e)&&(e=r.timestamp);return{size:m.size,maxSize:f.cache.maxSize,hitRate:`${L}/${L+k} (${L+k>0?Math.round(L/(L+k)*100):0}%)`,oldestEntry:e}}let L=0,k=0;const E=ae(),z=new Set;async function ge(e){try{if(!await E.hasRecentActivity()){a.debug("No recent activity, skipping predictive preload");return}const t=await E.predict(e);if(t.length===0)return;a.info(`Predictive preload: ${t.length} candidates for ${e}`);for(const n of t){const o=`${n.sourceLang}-${n.targetLang}`;if(z.has(o)){a.debug(`Model ${o} already preloaded`);continue}if(n.confidence<.3){a.debug(`Skipping low confidence prediction: ${o} (${n.confidence.toFixed(2)})`);continue}a.info(`Preloading predicted model: ${o} (confidence: ${n.confidence.toFixed(2)})`),S({type:"preloadModel",sourceLang:n.sourceLang,targetLang:n.targetLang,provider:h,priority:"low"}).then(i=>{i.preloaded&&(z.add(o),a.info(`Predictive preload complete: ${o}`))}).catch(i=>{a.warn(`Predictive preload failed for ${o}:`,i)})}}catch(r){a.warn("Predictive preload error:",r)}}async function pe(e,r){try{await E.recordDetection(e,r)}catch(t){a.warn("Failed to record language detection:",t)}}async function he(e){try{await E.recordTranslation(e)}catch(r){a.warn("Failed to record translation:",r)}}let T=null,M=0;const ye={maxRetries:f.retry.network.maxRetries,baseDelayMs:f.retry.network.baseDelayMs,maxDelayMs:f.retry.network.maxDelayMs},me={maxRetries:f.retry.offscreen.maxRetries,baseDelayMs:f.retry.offscreen.baseDelayMs,maxDelayMs:f.retry.offscreen.maxDelayMs};async function B(){if(T){await T;return}const e=chrome.runtime.getURL("src/offscreen/offscreen.html");try{if((await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[e]})).length>0){M=0;return}if(T){await T;return}console.log("[Background] Creating offscreen document..."),T=chrome.offscreen.createDocument({url:e,reasons:[chrome.offscreen.Reason.WORKERS],justification:"Run Transformers.js ML inference in document context"}),await T,T=null,M=0,console.log("[Background] Offscreen document created successfully")}catch(r){T=null,M++;const t=r instanceof Error?r.message:String(r);throw a.error(" Failed to create offscreen document:",t),M>=f.retry.maxOffscreenFailures?new Error("Translation engine failed to start. Please reload the extension or restart Chrome."):new Error(`Failed to initialize translation engine: ${t}`)}}async function we(){try{const e=chrome.runtime.getURL("src/offscreen/offscreen.html");(await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[e]})).length>0&&(await chrome.offscreen.closeDocument(),console.log("[Background] Closed existing offscreen document"))}catch(e){a.warn(" Error closing offscreen document:",e)}T=null,await new Promise(e=>setTimeout(e,500)),await B()}async function S(e,r=f.timeouts.offscreenMs){return W(async()=>(await B(),new Promise((t,n)=>{const o=setTimeout(()=>{n(new Error("Offscreen communication timeout"))},r);try{chrome.runtime.sendMessage({...e,target:"offscreen"},i=>{if(clearTimeout(o),chrome.runtime.lastError){n(new Error(chrome.runtime.lastError.message));return}if(i===void 0){n(new Error("No response from translation engine"));return}t(i)})}catch(i){clearTimeout(o),n(i)}})),me,t=>t.retryable?(t.technicalDetails.includes("offscreen")&&(console.log("[Background] Attempting offscreen document reset..."),we().catch(console.error)),!0):!1)}let A="smart",h="opus-mt";const v={requests:0,tokens:0,windowStart:Date.now()};function ve(e){const r=Date.now();return r-v.windowStart>f.rateLimits.windowMs&&(v.requests=0,v.tokens=0,v.windowStart=r),!(v.requests>=f.rateLimits.requestsPerMinute||v.tokens+e>f.rateLimits.tokensPerMinute)}function Te(e){v.requests++,v.tokens+=e}function Le(e){const r=Array.isArray(e)?e.join(" "):e;return Math.max(1,Math.ceil(r.length/4))}function I(e){let r=e.message;return e.suggestion&&(r+=`. ${e.suggestion}`),r}chrome.runtime.onMessage.addListener((e,r,t)=>"target"in e&&e.target==="offscreen"?!1:(Se(e).then(t).catch(n=>{const o=j(n);a.error(" Error:",o.technicalDetails),t({success:!1,error:I(o)})}),!0));async function Se(e){switch(e.type){case"ping":return{success:!0,status:"ready",provider:h};case"translate":return Fe(e);case"getUsage":return Oe();case"getProviders":return Be();case"preloadModel":return ke(e);case"setProvider":return Ee(e);case"getCacheStats":return _e();case"clearCache":return Ce();case"checkChromeTranslator":return Pe();case"getPredictionStats":return De();case"recordLanguageDetection":return Me(e);case"getCloudProviderStatus":return $e();case"setCloudApiKey":return Re(e);case"clearCloudApiKey":return be(e);case"getCloudProviderUsage":return xe(e);case"getProfilingStats":return Ae();case"clearProfilingStats":return Ie();case"getHistory":return Ue();case"clearHistory":return Ne();default:throw new Error(`Unknown message type: ${e.type}`)}}async function Ee(e){return h=e.provider,a.info(` Provider set to: ${h}`),await _({provider:h}),{success:!0,provider:h}}async function ke(e){const r=e.provider||h;a.info(` Preloading ${r} model: ${e.sourceLang} -> ${e.targetLang}`);try{return await S({type:"preloadModel",sourceLang:e.sourceLang,targetLang:e.targetLang,provider:r})}catch(t){return a.warn(" Preload failed:",t),{success:!1,error:t instanceof Error?t.message:String(t)}}}function _e(){return{success:!0,cache:X()}}function Ce(){const e=m.size;return m.clear(),L=0,k=0,a.info(` Cache cleared (was ${e} entries)`),{success:!0,clearedEntries:e}}async function Pe(){try{return{success:!0,available:(await S({type:"checkChromeTranslator"}))?.available??!1}}catch(e){return a.warn(" Chrome Translator check failed:",e),{success:!0,available:!1}}}async function De(){try{return{success:!0,prediction:await E.getStats()}}catch(e){return a.warn("Failed to get prediction stats:",e),{success:!1,error:e instanceof Error?e.message:String(e)}}}async function Me(e){return await pe(e.url,e.language),{success:!0}}const R={deepl:"deepl_api_key",openai:"openai_api_key",anthropic:"anthropic_api_key","google-cloud":"google_cloud_api_key"};async function $e(){try{const e=Object.values(R),r=await b(e),t={};for(const[n,o]of Object.entries(R))t[n]=!!r[o];return{success:!0,status:t}}catch(e){return a.warn("Failed to get cloud provider status:",e),{success:!1,error:e instanceof Error?e.message:String(e),status:{}}}}async function Re(e){const r=R[e.provider];if(!r)return{success:!1,error:`Unknown provider: ${e.provider}`};try{const t={[r]:e.apiKey};return e.provider==="deepl"&&e.options?(e.options.isPro!==void 0&&(t.deepl_is_pro=e.options.isPro),e.options.formality!==void 0&&(t.deepl_formality=e.options.formality)):e.provider==="openai"&&e.options?(e.options.model!==void 0&&(t.openai_model=e.options.model),e.options.formality!==void 0&&(t.openai_formality=e.options.formality)):e.provider==="anthropic"&&e.options&&(e.options.model!==void 0&&(t.anthropic_model=e.options.model),e.options.formality!==void 0&&(t.anthropic_formality=e.options.formality)),await _(t),a.info(` API key set for ${e.provider}`),{success:!0,provider:e.provider}}catch(t){return a.error(" Failed to set API key:",t),{success:!1,error:t instanceof Error?t.message:String(t)}}}async function be(e){const r=R[e.provider];if(!r)return{success:!1,error:`Unknown provider: ${e.provider}`};try{const t=[r];return e.provider==="deepl"?t.push("deepl_is_pro","deepl_formality"):e.provider==="openai"?t.push("openai_model","openai_formality","openai_temperature","openai_tokens_used"):e.provider==="anthropic"?t.push("anthropic_model","anthropic_formality","anthropic_tokens_used"):e.provider==="google-cloud"&&t.push("google_cloud_chars_used"),await chrome.storage.local.remove(t),a.info(` API key cleared for ${e.provider}`),{success:!0,provider:e.provider}}catch(t){return a.error(" Failed to clear API key:",t),{success:!1,error:t instanceof Error?t.message:String(t)}}}async function xe(e){try{return await S({type:"getCloudProviderUsage",provider:e.provider})}catch(r){return a.warn(" Failed to get cloud provider usage:",r),{success:!1,error:r instanceof Error?r.message:String(r)}}}async function Fe(e){const r=Date.now(),t=e.enableProfiling?d.startSession():void 0;t&&(d.startTiming(t,"total"),d.startTiming(t,"validation"));try{const n=Z(e.text,e.sourceLang,e.targetLang);if(t&&d.endTiming(t,"validation"),!n.valid)return{success:!1,error:I(n.error),duration:Date.now()-r};const o=n.sanitizedText;e.options?.strategy&&(A=e.options.strategy);const i=e.provider||h;t&&d.startTiming(t,"cache_lookup");const u=de(o,e.sourceLang,e.targetLang,i);if(e.sourceLang!=="auto"){const c=ue(u);if(t&&d.endTiming(t,"cache_lookup"),c){L++;const p=Date.now()-r;return a.info(` Cache hit, returning in ${p}ms`),t&&d.endTiming(t,"total"),{success:!0,result:c.result,duration:p,cached:!0}}}else t&&d.endTiming(t,"cache_lookup");k++;const s=Le(o);if(!ve(s))return{success:!1,error:"Too many requests. Please wait a moment and try again.",duration:Date.now()-r};console.log("[Background] Translating:",e.sourceLang,"->",e.targetLang),t&&d.startTiming(t,"ipc_background_to_offscreen");const l=await W(async()=>{const c=await S({type:"translate",text:o,sourceLang:e.sourceLang,targetLang:e.targetLang,provider:i,sessionId:t});if(!c)throw new Error("No response from translation engine");if(!c.success){const p=typeof c.error=="string"?c.error:c.error instanceof Error?c.error.message:JSON.stringify(c.error)||"Translation failed";throw new Error(p)}return c},ye,c=>Q(c.technicalDetails));t&&(d.endTiming(t,"ipc_background_to_offscreen"),l.profilingData&&d.importSessionData(l.profilingData)),console.log("[Background] Translation complete"),Te(s),t&&d.startTiming(t,"cache_store");const g=e.sourceLang==="auto"?"auto":e.sourceLang;l.result&&g!=="auto"&&fe(u,l.result,g,e.targetLang),t&&(d.endTiming(t,"cache_store"),d.endTiming(t,"total")),he(e.targetLang).catch(()=>{}),l.result&&typeof o=="string"&&typeof l.result=="string"&&ce(o,l.result,e.sourceLang,e.targetLang).catch(()=>{});let y;if(t){const c=d.getReport(t);c&&(y=c,console.log(d.formatReport(t)))}return{success:!0,result:l.result,duration:Date.now()-r,profilingReport:y}}catch(n){t&&d.endTiming(t,"total");const o=j(n);return a.error(" Translation error:",o.technicalDetails),{success:!1,error:I(o),duration:Date.now()-r}}}function Oe(){return{throttle:{requests:v.requests,tokens:v.tokens,requestLimit:f.rateLimits.requestsPerMinute,tokenLimit:f.rateLimits.tokensPerMinute,queue:0},cache:X(),providers:{}}}async function Ae(){try{const e=d.getAllAggregates();let r={};try{const n=await S({type:"getProfilingStats"});n?.success&&n.aggregates&&(r=n.aggregates)}catch{}return{success:!0,aggregates:{...e,...r},formatted:d.formatAggregates()}}catch(e){return a.warn("Failed to get profiling stats:",e),{success:!1,error:e instanceof Error?e.message:String(e)}}}function Ie(){return d.clear(),a.info("Profiling stats cleared"),{success:!0}}async function Ue(){try{return{success:!0,history:await Y()}}catch(e){return a.warn("Failed to get history:",e),{success:!1,error:e instanceof Error?e.message:String(e),history:[]}}}async function Ne(){try{return await le(),{success:!0}}catch(e){return a.warn("Failed to clear history:",e),{success:!1,error:e instanceof Error?e.message:String(e)}}}async function Be(){try{const e=await S({type:"getSupportedLanguages"});return{providers:[{id:"opus-mt",name:"Helsinki-NLP OPUS-MT",type:"local",qualityTier:"standard",description:"Fast, lightweight (~170MB per pair)",icon:""},{id:"translategemma",name:"TranslateGemma 4B",type:"local",qualityTier:"premium",description:"High quality, single model (~3.6GB)",icon:""}],activeProvider:h,strategy:A,supportedLanguages:e.success?e.languages:[]}}catch(e){return a.warn(" Error getting providers:",e),{providers:[{id:"opus-mt",name:"Helsinki-NLP OPUS-MT",type:"local",qualityTier:"standard",description:"Fast, lightweight (~170MB per pair)",icon:""},{id:"translategemma",name:"TranslateGemma 4B",type:"local",qualityTier:"premium",description:"High quality, single model (~3.6GB)",icon:""}],activeProvider:h,strategy:A,supportedLanguages:[],error:"Could not load language list. Translation may still work."}}}chrome.action.onClicked.addListener(async e=>{e.id&&console.log("[Background] Extension icon clicked for tab:",e.id)});chrome.commands.onCommand.addListener(async(e,r)=>{if(console.log("[Background] Command received:",e),e==="translate-selection"&&r?.id)try{const t=await b(["sourceLang","targetLang","strategy","provider"]);await chrome.tabs.sendMessage(r.id,{type:"translateSelection",sourceLang:t.sourceLang||"auto",targetLang:t.targetLang||"en",strategy:t.strategy||"smart",provider:t.provider||h})}catch(t){a.warn("Failed to translate selection via keyboard shortcut:",t)}});chrome.tabs.onUpdated.addListener((e,r,t)=>{r.status==="complete"&&t.url&&!t.url.startsWith("chrome://")&&(a.debug(`Tab updated: ${t.url}`),ge(t.url).catch(n=>{a.warn("Predictive preload trigger failed:",n)}))});chrome.runtime.onInstalled.addListener(e=>{if(e.reason==="install"){console.log("[Background] Extension installed");const r=chrome.i18n.getUILanguage().split("-")[0];console.log("[Background] Browser language detected:",r),_({sourceLang:"auto",targetLang:r||"en",strategy:"smart",provider:"opus-mt"})}else e.reason==="update"&&console.log("[Background] Extension updated from",e.previousVersion)});(async()=>{const e=await b(["provider"]);e.provider&&(h=e.provider,console.log("[Background] Restored provider:",h))})();chrome.runtime.onStartup.addListener(()=>{console.log("[Background] Extension startup, pre-warming offscreen document..."),B().catch(e=>{a.warn(" Pre-warm failed (will retry on first use):",e)})});(async()=>{try{await E.load(),console.log("[Background] Prediction engine initialized")}catch(e){a.warn("Failed to initialize prediction engine:",e)}})();console.log("[Background] Service worker initialized v2.3 with predictive model preloading");
//# sourceMappingURL=background.js.map
