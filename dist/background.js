import{c as O}from"./assets/logger-B_opVjnm.js";import{s as R,a as N}from"./assets/storage-DD7EaGDa.js";import{C as s}from"./assets/config-C4jcdPcN.js";const z={network:[/fetch failed/i,/network/i,/ERR_NETWORK/i,/ERR_CONNECTION/i,/ERR_INTERNET/i,/offline/i,/CORS/i,/Failed to fetch/i,/net::/i,/Connection refused/i,/timeout.*network/i],memory:[/out of memory/i,/OOM/i,/allocation failed/i,/memory limit/i,/heap/i,/RangeError.*Maximum/i,/WebAssembly.*memory/i,/wasm.*memory/i],model:[/model.*download/i,/model.*load/i,/model.*not found/i,/HuggingFace/i,/pipeline/i,/transformers/i,/ONNX/i,/wasm.*load/i,/WebGPU/i],language:[/unsupported language/i,/language pair/i,/invalid.*lang/i,/unknown language/i],timeout:[/timeout/i,/timed out/i,/deadline/i,/took too long/i],input:[/invalid input/i,/empty text/i,/text too long/i,/invalid character/i,/malformed/i]};function b(e){const t=e instanceof Error?e.message:String(e);for(const[r,n]of Object.entries(z))if(n.some(a=>a.test(t)))return r;return"internal"}function M(e){const t=e instanceof Error?e.message:String(e),r=b(e);switch(r){case"network":return{category:r,message:"Unable to connect to translation service",technicalDetails:t,retryable:!0,suggestion:"Check your internet connection and try again"};case"memory":return{category:r,message:"Not enough memory to complete translation",technicalDetails:t,retryable:!0,suggestion:"Try closing other tabs or using a smaller text selection"};case"model":return{category:r,message:"Translation model failed to load",technicalDetails:t,retryable:!0,suggestion:"The model may still be downloading. Please wait and try again."};case"language":return{category:r,message:"Language pair not supported",technicalDetails:t,retryable:!1,suggestion:"Please select a different source or target language"};case"timeout":return{category:r,message:"Translation took too long",technicalDetails:t,retryable:!0,suggestion:"Try with a shorter text or wait for the model to fully load"};case"input":return{category:r,message:"Invalid text for translation",technicalDetails:t,retryable:!1,suggestion:"Please check the text and try again"};default:return{category:"internal",message:"Translation failed unexpectedly",technicalDetails:t,retryable:!0,suggestion:"Please try again. If the problem persists, reload the extension."}}}const S={maxRetries:3,baseDelayMs:1e3,maxDelayMs:3e4,jitterFactor:.3};function B(e,t=S){const r=t.baseDelayMs*Math.pow(2,e),n=Math.min(r,t.maxDelayMs),a=n*t.jitterFactor*(Math.random()*2-1);return Math.max(t.baseDelayMs,Math.floor(n+a))}async function P(e,t={},r){const n={...S,...t};let a=null;for(let o=0;o<=n.maxRetries;o++)try{return await e()}catch(g){if(a=M(g),!(r?r(a):a.retryable)||o===n.maxRetries)throw g;const h=B(o,n);console.log(`[Retry] Attempt ${o+1}/${n.maxRetries} failed: ${a.message}. Retrying in ${h}ms...`),await new Promise(i=>setTimeout(i,h))}throw a}const x=1e4,v=100;function F(e,t,r){if(!e)return{valid:!1,error:{category:"input",message:"No text provided for translation",technicalDetails:"Input text was null, undefined, or empty",retryable:!1,suggestion:"Please select or enter some text to translate"}};if(Array.isArray(e)){if(e.length===0)return{valid:!1,error:{category:"input",message:"No text provided for translation",technicalDetails:"Input array was empty",retryable:!1}};if(e.length>v)return{valid:!1,error:{category:"input",message:`Too many texts in batch (max ${v})`,technicalDetails:`Batch size ${e.length} exceeds limit of ${v}`,retryable:!1,suggestion:"Please translate fewer items at once"}};const a=e.map(g=>k(g)),o=a.reduce((g,y)=>g+y.length,0);return o>x*2?{valid:!1,error:{category:"input",message:"Total text length exceeds maximum",technicalDetails:`Total length ${o} exceeds limit`,retryable:!1,suggestion:"Please translate smaller portions of text"}}:{valid:!0,sanitizedText:a}}const n=k(e);return n.length===0?{valid:!1,error:{category:"input",message:"Text contains no translatable content",technicalDetails:"After sanitization, text was empty",retryable:!1}}:n.length>x?{valid:!1,error:{category:"input",message:`Text too long (max ${x} characters)`,technicalDetails:`Text length ${n.length} exceeds limit of ${x}`,retryable:!1,suggestion:"Please select a smaller portion of text"}}:t!=="auto"&&!/^[a-z]{2,3}$/i.test(t)?{valid:!1,error:{category:"language",message:"Invalid source language code",technicalDetails:`Source language "${t}" is not a valid ISO code`,retryable:!1}}:/^[a-z]{2,3}$/i.test(r)?{valid:!0,sanitizedText:n}:{valid:!1,error:{category:"language",message:"Invalid target language code",technicalDetails:`Target language "${r}" is not a valid ISO code`,retryable:!1}}}function k(e){return e.normalize("NFC").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"").replace(/[ \t]+/g," ").trim()}function I(e){return b(e)==="network"}const c=O("Background"),l=new Map;function U(e,t,r,n){const a=Array.isArray(e)?e.map(g=>g.substring(0,50)).join("|").substring(0,200):e.substring(0,100);return`${n||u}:${t}-${r}-${a}`}function q(e){const t=l.get(e);return t&&(l.delete(e),l.set(e,t),c.info(` Cache HIT: ${e.substring(0,40)}...`)),t}function _(e,t,r,n){for(;l.size>=s.cache.maxSize;){const a=l.keys().next().value;a&&(l.delete(a),c.info(" Cache evicted oldest entry"))}l.set(e,{result:t,timestamp:Date.now(),sourceLang:r,targetLang:n}),c.info(` Cached translation (${l.size}/${s.cache.maxSize})`)}function $(){let e=null;for(const t of l.values())(e===null||t.timestamp<e)&&(e=t.timestamp);return{size:l.size,maxSize:s.cache.maxSize,hitRate:`${m}/${m+p} (${m+p>0?Math.round(m/(m+p)*100):0}%)`,oldestEntry:e}}let m=0,p=0,f=null,T=0;const A={maxRetries:s.retry.network.maxRetries,baseDelayMs:s.retry.network.baseDelayMs,maxDelayMs:s.retry.network.maxDelayMs},G={maxRetries:s.retry.offscreen.maxRetries,baseDelayMs:s.retry.offscreen.baseDelayMs,maxDelayMs:s.retry.offscreen.maxDelayMs};async function L(){const e=chrome.runtime.getURL("src/offscreen/offscreen.html");try{if((await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[e]})).length>0){T=0;return}if(f){await f;return}console.log("[Background] Creating offscreen document..."),f=chrome.offscreen.createDocument({url:e,reasons:[chrome.offscreen.Reason.WORKERS],justification:"Run Transformers.js ML inference in document context"}),await f,f=null,T=0,console.log("[Background] Offscreen document created successfully")}catch(t){f=null,T++;const r=t instanceof Error?t.message:String(t);throw c.error(" Failed to create offscreen document:",r),T>=s.retry.maxOffscreenFailures?new Error("Translation engine failed to start. Please reload the extension or restart Chrome."):new Error(`Failed to initialize translation engine: ${r}`)}}async function H(){try{const e=chrome.runtime.getURL("src/offscreen/offscreen.html");(await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[e]})).length>0&&(await chrome.offscreen.closeDocument(),console.log("[Background] Closed existing offscreen document"))}catch(e){c.warn(" Error closing offscreen document:",e)}f=null,await new Promise(e=>setTimeout(e,500)),await L()}async function C(e,t=s.timeouts.offscreenMs){return P(async()=>(await L(),new Promise((r,n)=>{const a=setTimeout(()=>{n(new Error("Offscreen communication timeout"))},t);try{chrome.runtime.sendMessage({...e,target:"offscreen"},o=>{if(clearTimeout(a),chrome.runtime.lastError){n(new Error(chrome.runtime.lastError.message));return}if(o===void 0){n(new Error("No response from translation engine"));return}r(o)})}catch(o){clearTimeout(a),n(o)}})),G,r=>r.retryable?(r.technicalDetails.includes("offscreen")&&(console.log("[Background] Attempting offscreen document reset..."),H().catch(console.error)),!0):!1)}let E="smart",u="opus-mt";const d={requests:0,tokens:0,windowStart:Date.now()};function K(e){const t=Date.now();return t-d.windowStart>s.rateLimits.windowMs&&(d.requests=0,d.tokens=0,d.windowStart=t),!(d.requests>=s.rateLimits.requestsPerMinute||d.tokens+e>s.rateLimits.tokensPerMinute)}function j(e){d.requests++,d.tokens+=e}function W(e){const t=Array.isArray(e)?e.join(" "):e;return Math.max(1,Math.ceil(t.length/4))}function D(e){let t=e.message;return e.suggestion&&(t+=`. ${e.suggestion}`),t}chrome.runtime.onMessage.addListener((e,t,r)=>"target"in e&&e.target==="offscreen"?!1:(X(e).then(r).catch(n=>{const a=M(n);c.error(" Error:",a.technicalDetails),r({success:!1,error:D(a)})}),!0));async function X(e){switch(e.type){case"ping":return{success:!0,status:"ready",provider:u};case"translate":return Q(e);case"getUsage":return ee();case"getProviders":return te();case"preloadModel":return J(e);case"setProvider":return Y(e);case"getCacheStats":return V();case"clearCache":return Z();default:throw new Error(`Unknown message type: ${e.type}`)}}async function Y(e){return u=e.provider,c.info(` Provider set to: ${u}`),await R({provider:u}),{success:!0,provider:u}}async function J(e){const t=e.provider||u;c.info(` Preloading ${t} model: ${e.sourceLang} -> ${e.targetLang}`);try{return await C({type:"preloadModel",sourceLang:e.sourceLang,targetLang:e.targetLang,provider:t})}catch(r){return c.warn(" Preload failed:",r),{success:!1,error:r instanceof Error?r.message:String(r)}}}function V(){return{success:!0,cache:$()}}function Z(){const e=l.size;return l.clear(),m=0,p=0,c.info(` Cache cleared (was ${e} entries)`),{success:!0,clearedEntries:e}}async function Q(e){const t=Date.now();try{const r=F(e.text,e.sourceLang,e.targetLang);if(!r.valid)return{success:!1,error:D(r.error),duration:Date.now()-t};const n=r.sanitizedText;e.options?.strategy&&(E=e.options.strategy);const a=e.provider||u,o=U(n,e.sourceLang,e.targetLang,a);if(e.sourceLang!=="auto"){const i=q(o);if(i){m++;const w=Date.now()-t;return c.info(` Cache hit, returning in ${w}ms`),{success:!0,result:i.result,duration:w,cached:!0}}}p++;const g=W(n);if(!K(g))return{success:!1,error:"Too many requests. Please wait a moment and try again.",duration:Date.now()-t};console.log("[Background] Translating:",e.sourceLang,"->",e.targetLang);const y=await P(async()=>{const i=await C({type:"translate",text:n,sourceLang:e.sourceLang,targetLang:e.targetLang,provider:a});if(!i)throw new Error("No response from translation engine");if(!i.success){const w=typeof i.error=="string"?i.error:i.error instanceof Error?i.error.message:JSON.stringify(i.error)||"Translation failed";throw new Error(w)}return i},A,i=>I(i.technicalDetails));console.log("[Background] Translation complete"),j(g);const h=e.sourceLang==="auto"?"auto":e.sourceLang;return y.result&&h!=="auto"&&_(o,y.result,h,e.targetLang),{success:!0,result:y.result,duration:Date.now()-t}}catch(r){const n=M(r);return c.error(" Translation error:",n.technicalDetails),{success:!1,error:D(n),duration:Date.now()-t}}}function ee(){return{throttle:{requests:d.requests,tokens:d.tokens,requestLimit:s.rateLimits.requestsPerMinute,tokenLimit:s.rateLimits.tokensPerMinute,queue:0},cache:$(),providers:{}}}async function te(){try{const e=await C({type:"getSupportedLanguages"});return{providers:[{id:"opus-mt",name:"Helsinki-NLP OPUS-MT",type:"local",qualityTier:"standard",description:"Fast, lightweight (~170MB per pair)",icon:""},{id:"translategemma",name:"TranslateGemma 4B",type:"local",qualityTier:"premium",description:"High quality, single model (~3.6GB)",icon:""}],activeProvider:u,strategy:E,supportedLanguages:e.success?e.languages:[]}}catch(e){return c.warn(" Error getting providers:",e),{providers:[{id:"opus-mt",name:"Helsinki-NLP OPUS-MT",type:"local",qualityTier:"standard",description:"Fast, lightweight (~170MB per pair)",icon:""},{id:"translategemma",name:"TranslateGemma 4B",type:"local",qualityTier:"premium",description:"High quality, single model (~3.6GB)",icon:""}],activeProvider:u,strategy:E,supportedLanguages:[],error:"Could not load language list. Translation may still work."}}}chrome.action.onClicked.addListener(async e=>{e.id&&console.log("[Background] Extension icon clicked for tab:",e.id)});chrome.runtime.onInstalled.addListener(e=>{if(e.reason==="install"){console.log("[Background] Extension installed");const t=chrome.i18n.getUILanguage().split("-")[0];console.log("[Background] Browser language detected:",t),R({sourceLang:"auto",targetLang:t||"en",strategy:"smart",provider:"opus-mt"})}else e.reason==="update"&&console.log("[Background] Extension updated from",e.previousVersion)});(async()=>{const e=await N(["provider"]);e.provider&&(u=e.provider,console.log("[Background] Restored provider:",u))})();chrome.runtime.onStartup.addListener(()=>{console.log("[Background] Extension startup, pre-warming offscreen document..."),L().catch(e=>{c.warn(" Pre-warm failed (will retry on first use):",e)})});console.log("[Background] Service worker initialized v2.2 with TranslateGemma + caching + preload");
//# sourceMappingURL=background.js.map
