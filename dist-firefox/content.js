(function(){"use strict";function rt(t){return{debug:(e,...n)=>console.log(`[${t}]`,e,...n),info:(e,...n)=>console.log(`[${t}]`,e,...n),warn:(e,...n)=>console.warn(`[${t}]`,e,...n),error:(e,...n)=>console.error(`[${t}]`,e,...n)}}const C=rt("SiteRules"),b="siteRules";function Nt(t,e){if(e===t)return!0;if(e.startsWith("*.")){const n=e.slice(2);return t===n||t.endsWith("."+n)}return!1}function Bt(t,e){if(e[t])return{pattern:t,rules:e[t]};const n=Object.keys(e).filter(o=>o.startsWith("*.")).sort((o,r)=>r.length-o.length);for(const o of n)if(Nt(t,o))return{pattern:o,rules:e[o]};return null}async function me(t){try{const n=(await chrome.storage.local.get(b))[b]||{},o=Bt(t,n);return o?o.rules:null}catch(e){return C.error(" Failed to get rules:",e),null}}async function he(t,e){try{const o=(await chrome.storage.local.get(b))[b]||{};o[t]=e,await chrome.storage.local.set({[b]:o}),C.info(" Updated rules for:",t,e)}catch(n){throw C.error(" Failed to set rules:",n),n}}async function ye(t){try{const n=(await chrome.storage.local.get(b))[b]||{};delete n[t],await chrome.storage.local.set({[b]:n}),C.info(" Cleared rules for:",t)}catch(e){throw C.error(" Failed to clear rules:",e),e}}async function Tt(){try{return(await chrome.storage.local.get(b))[b]||{}}catch(t){return C.error(" Failed to get all rules:",t),{}}}async function xe(){try{await chrome.storage.local.remove(b),C.info(" Cleared all rules")}catch(t){throw C.error(" Failed to clear all rules:",t),t}}async function be(){const t=await Tt();return JSON.stringify(t,null,2)}async function we(t){try{const e=JSON.parse(t);for(const[r,a]of Object.entries(e)){if(typeof r!="string")throw new Error(`Invalid hostname: ${r}`);if(typeof a!="object"||a===null)throw new Error(`Invalid rules for ${r}`);if(typeof a.autoTranslate!="boolean")throw new Error(`Invalid autoTranslate for ${r}`)}const o={...await Tt(),...e};return await chrome.storage.local.set({[b]:o}),C.info(" Imported",Object.keys(e).length,"rules"),Object.keys(e).length}catch(e){throw C.error(" Failed to import rules:",e),e}}const ve={getRules:me,setRules:he,clearRules:ye,getAllRules:Tt,clearAllRules:xe,exportRules:be,importRules:we,matchesPattern:Nt,findMatchingRule:Bt},M=rt("Glossary"),Te="​⁣TERM_",Ee="⁣​",W="glossary";async function N(){try{return(await chrome.storage.local.get(W))[W]||{}}catch(t){return M.error(" Failed to get glossary:",t),{}}}async function Ce(t,e,n=!1,o){if(!t||!e)throw new Error("Term and replacement are required");try{const r=await N();r[t]={replacement:e,caseSensitive:n,description:o},await chrome.storage.local.set({[W]:r}),M.info(" Added term:",t,"->",e)}catch(r){throw M.error(" Failed to add term:",r),r}}async function Se(t){try{const e=await N();delete e[t],await chrome.storage.local.set({[W]:e}),M.info(" Removed term:",t)}catch(e){throw M.error(" Failed to remove term:",e),e}}async function ke(){try{await chrome.storage.local.remove(W),M.info(" Cleared glossary")}catch(t){throw M.error(" Failed to clear glossary:",t),t}}function Dt(t,e){const n=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return new RegExp(`\\b${n}\\b`,e?"g":"gi")}function Me(t,e){let n=t;const o=Object.keys(e).sort((r,a)=>a.length-r.length);for(const r of o){const a=e[r],i=Dt(r,a.caseSensitive);n=n.replace(i,a.replacement)}return n}function Et(t,e){let n=t;const o=new Map;let r=0;const a=Object.keys(e).sort((i,l)=>l.length-i.length);for(const i of a){const l=e[i],s=Dt(i,l.caseSensitive);n=n.replace(s,()=>{const c=`${Te}${r}${Ee}`;return o.set(c,l.replacement),r++,c})}return{text:n,placeholderMap:o}}function Ct(t,e){let n=t;for(const[o,r]of e)n=n.split(o).join(r);return n}async function Le(t,e){const n=e??await N();if(Object.keys(n).length===0)return{processedText:t,restore:a=>a};const{text:o,placeholderMap:r}=Et(t,n);return{processedText:o,restore:a=>Ct(a,r)}}async function Ae(t,e){const n=e??await N();if(Object.keys(n).length===0)return{processedTexts:t,restoreFns:t.map(()=>r=>r)};const o=t.map(r=>{const{text:a,placeholderMap:i}=Et(r,n);return{processedText:a,restore:l=>Ct(l,i)}});return{processedTexts:o.map(r=>r.processedText),restoreFns:o.map(r=>r.restore)}}async function Ie(){const t=await N();return JSON.stringify(t,null,2)}async function Re(t){try{const e=JSON.parse(t);for(const[r,a]of Object.entries(e)){if(typeof r!="string")throw new Error(`Invalid term: ${r}`);if(typeof a!="object"||a===null)throw new Error(`Invalid entry for term: ${r}`);if(typeof a.replacement!="string")throw new Error(`Invalid replacement for term: ${r}`);if(typeof a.caseSensitive!="boolean")throw new Error(`Invalid caseSensitive for term: ${r}`)}const o={...await N(),...e};return await chrome.storage.local.set({[W]:o}),M.info(" Imported",Object.keys(e).length,"terms"),Object.keys(e).length}catch(e){throw M.error(" Failed to import glossary:",e),e}}const St={getGlossary:N,addTerm:Ce,removeTerm:Se,clearGlossary:ke,applyGlossary:Le,applyGlossaryBatch:Ae,applyGlossaryPreProcess:Me,applyGlossaryWithPlaceholders:Et,restorePlaceholders:Ct,exportGlossary:Ie,importGlossary:Re},v={cache:{maxSize:1e3,storageKey:"translationMemory",saveDebounceMs:5e3},timeouts:{opusMtDirectMs:60*1e3,opusMtPivotMs:2*60*1e3,translateGemmaMs:5*60*1e3,modelLoadMs:2*60*1e3,offscreenMs:2*60*1e3},rateLimits:{requestsPerMinute:60,tokensPerMinute:1e5,windowMs:6e4},batching:{maxSize:50,maxTextLength:5e3,minTextLength:2},retry:{network:{maxRetries:3,baseDelayMs:1e3,maxDelayMs:1e4},offscreen:{maxRetries:2,baseDelayMs:500,maxDelayMs:3e3},maxOffscreenFailures:3},mutations:{debounceMs:500,maxPending:500},throttle:{requestLimit:60,tokenLimit:1e5,windowMs:6e4}},S=typeof browser<"u"?browser:chrome,Oe=rt("Storage");async function at(t){try{return await S.storage.local.get(t)}catch(e){return Oe.warn("Storage get failed:",e),{}}}const f=rt("Content"),it=100;class st{buffer;writeIndex=0;count=0;constructor(e){this.buffer=new Float64Array(e)}push(e){this.buffer[this.writeIndex]=e,this.writeIndex=(this.writeIndex+1)%this.buffer.length,this.count<this.buffer.length&&this.count++}getStats(){if(this.count===0)return null;let e=0,n=1/0,o=-1/0;for(let r=0;r<this.count;r++){const a=this.buffer[r];e+=a,a<n&&(n=a),a>o&&(o=a)}return{avg:e/this.count,min:n,max:o,count:this.count}}}const zt={domScan:new st(it),domUpdate:new st(it),glossaryApply:new st(it),ipcRoundtrip:new st(it)};function lt(t,e){zt[t].push(e)}function $e(){const t={};for(const[e,n]of Object.entries(zt)){const o=n.getStats();o&&(t[e]=o)}return t}const Fe=new Set(["SCRIPT","STYLE","NOSCRIPT","TEMPLATE","CODE","PRE","TEXTAREA","INPUT","SELECT","BUTTON","SVG","MATH","CANVAS","VIDEO","AUDIO","IFRAME","OBJECT","EMBED"]),B="data-translated",j="data-original-text",Ht="data-machine-translation",_t="data-source-lang",Pt="data-target-lang";let ct=!1,kt=!1,q=[],D=null,U=null,Q=[];const Mt=new WeakMap;let p=null,tt=null,z=null;function x(t,e=3e3){const n=document.getElementById("translate-ext-toast");n&&n!==z&&n.remove();const o=document.createElement("div");o.id="translate-ext-toast",o.textContent=t,Object.assign(o.style,{position:"fixed",bottom:"20px",left:"50%",transform:"translateX(-50%)",background:"#1e293b",color:"#f1f5f9",padding:"12px 20px",borderRadius:"8px",fontSize:"14px",fontFamily:"system-ui, -apple-system, sans-serif",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",zIndex:"2147483647",opacity:"0",transition:"opacity 0.2s ease"}),document.body.appendChild(o),requestAnimationFrame(()=>{o.style.opacity="1"}),setTimeout(()=>{o.style.opacity="0",setTimeout(()=>o.remove(),200)},e)}function Ne(t){dt();const e=document.createElement("div");return e.id="translate-ext-progress-toast",Object.assign(e.style,{position:"fixed",bottom:"20px",left:"50%",transform:"translateX(-50%)",background:"#1e293b",color:"#f1f5f9",padding:"12px 20px",borderRadius:"8px",fontSize:"14px",fontFamily:"system-ui, -apple-system, sans-serif",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",zIndex:"2147483647",opacity:"0",transition:"opacity 0.2s ease",display:"flex",alignItems:"center",gap:"10px",minWidth:"200px"}),e.innerHTML=`
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="flex-shrink: 0; animation: translate-spin 1s linear infinite;">
      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-dasharray="31.4 31.4" stroke-linecap="round"/>
    </svg>
    <span class="translate-progress-text">${t}</span>
    <style>
      @keyframes translate-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
  `,document.body.appendChild(e),z=e,requestAnimationFrame(()=>{e.style.opacity="1"}),e}function Wt(t){if(!z)return;const e=z.querySelector(".translate-progress-text");e&&(e.textContent=t)}function dt(){if(z){const e=z;z=null,e.style.opacity="0",setTimeout(()=>e.remove(),200)}const t=document.getElementById("translate-ext-progress-toast");t&&(t.style.opacity="0",setTimeout(()=>t.remove(),200))}function L(t,e=6e3){const n=document.getElementById("translate-ext-toast");n&&n.remove();const o=document.createElement("div");o.id="translate-ext-toast",Object.assign(o.style,{position:"fixed",bottom:"20px",left:"50%",transform:"translateX(-50%)",background:"#991b1b",color:"#fef2f2",padding:"12px 20px",borderRadius:"8px",fontSize:"14px",fontFamily:"system-ui, -apple-system, sans-serif",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.25)",zIndex:"2147483647",opacity:"0",transition:"opacity 0.2s ease",maxWidth:"400px",textAlign:"center",lineHeight:"1.4"});const r=document.createElement("div");Object.assign(r.style,{display:"flex",alignItems:"flex-start",gap:"10px"}),r.innerHTML=`
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="flex-shrink: 0; margin-top: 2px;">
      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
      <line x1="12" y1="8" x2="12" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <circle cx="12" cy="16" r="1" fill="currentColor"/>
    </svg>
  `;const a=document.createElement("span");a.textContent=t,r.appendChild(a),o.appendChild(r),document.body.appendChild(o),requestAnimationFrame(()=>{o.style.opacity="1"}),setTimeout(()=>{o.style.opacity="0",setTimeout(()=>o.remove(),200)},e)}function Be(t){t.hasAttribute("data-correction-enabled")||(t.setAttribute("data-correction-enabled","true"),t.style.cursor="text",t.addEventListener("click",e=>{t.getAttribute("contenteditable")!=="true"&&(e.target.closest("a")||(e.preventDefault(),e.stopPropagation(),De(t)))}))}function De(t){const e=t.getAttribute(Ht),n=t.getAttribute(j),o=t.getAttribute(_t),r=t.getAttribute(Pt);if(!e||!n||!o||!r){f.warn("Missing data for correction editing");return}const a=t.textContent||"";t.setAttribute("contenteditable","true"),t.style.outline="2px solid #3b82f6",t.style.outlineOffset="2px",t.style.borderRadius="2px",t.style.minWidth="20px",t.focus();const i=window.getSelection(),l=document.createRange();l.selectNodeContents(t),i?.removeAllRanges(),i?.addRange(l);const s=async()=>{t.removeAttribute("contenteditable"),t.style.outline="",t.style.outlineOffset="";const d=t.textContent?.trim()||"";if(!d){t.textContent=a;return}if(d!==a&&d!==e)try{await S.runtime.sendMessage({type:"addCorrection",original:n.trim(),machineTranslation:e,userCorrection:d,sourceLang:o,targetLang:r}),x("Correction saved! Future translations will use your preference."),f.info("Correction saved:",{original:n.substring(0,30),correction:d.substring(0,30)})}catch(u){f.error("Failed to save correction:",u),L("Failed to save correction")}else d===e&&(t.textContent=a)};t.addEventListener("blur",s,{once:!0});const c=d=>{d.key==="Enter"&&!d.shiftKey?(d.preventDefault(),t.blur()):d.key==="Escape"&&(d.preventDefault(),t.textContent=a,t.blur())};t.addEventListener("keydown",c),t.addEventListener("blur",()=>{t.removeEventListener("keydown",c)},{once:!0})}let ut=!1;function ze(t){if(ut)return;const e="translate_correction_hint_shown";at([e]).then(n=>{if(n[e]){ut=!0;return}const o=document.createElement("div");o.id="translate-correction-hint",Object.assign(o.style,{position:"fixed",bottom:"60px",left:"50%",transform:"translateX(-50%)",background:"#1e40af",color:"#dbeafe",padding:"10px 16px",borderRadius:"8px",fontSize:"13px",fontFamily:"system-ui, -apple-system, sans-serif",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",zIndex:"2147483647",maxWidth:"320px",textAlign:"center",lineHeight:"1.4"}),o.textContent="Tip: Click on any translated text to edit it. Your corrections will be remembered for future translations!",document.body.appendChild(o),ut=!0,S.storage?.local?.set({[e]:!0}).catch(()=>{}),setTimeout(()=>{o.style.opacity="0",o.style.transition="opacity 0.3s ease",setTimeout(()=>o.remove(),300)},6e3)}).catch(()=>{ut=!0})}let Lt=null,At="",G=!1;const A=new Map;function He(t,e){const n=document.caretRangeFromPoint?.(t,e);if(!n)return null;const o=n.startContainer;if(o.nodeType!==Node.TEXT_NODE)return null;const r=o.parentElement;if(!r||mt(r))return null;const a=o.textContent||"",i=n.startOffset;let l=i,s=i;for(;l>0&&/\S/.test(a[l-1]);)l--;for(;s<a.length&&/\S/.test(a[s]);)s++;const c=a.slice(l,s).trim();if(!c||c.length<2)return null;const d=document.createRange();return d.setStart(o,l),d.setEnd(o,s),{text:c,range:d}}function jt(t,e,n){H();const o=document.createElement("div");o.id="translate-hover-tooltip",o.className="translate-hover-tooltip",o.innerHTML=`
    <div class="hover-original">${gt(t)}</div>
    <div class="hover-arrow">-></div>
    <div class="hover-translation">${gt(e)}</div>
  `,Object.assign(o.style,{position:"fixed",top:`${Math.max(8,n.top-50)}px`,left:`${Math.max(8,Math.min(n.left,window.innerWidth-320))}px`,maxWidth:"300px",padding:"8px 12px",background:"linear-gradient(135deg, #1e293b 0%, #334155 100%)",color:"#f1f5f9",borderRadius:"8px",fontSize:"13px",lineHeight:"1.4",boxShadow:"0 8px 24px rgba(0, 0, 0, 0.25)",zIndex:"2147483647",animation:"hoverFadeIn 0.15s ease",display:"flex",alignItems:"center",gap:"8px",pointerEvents:"none",fontFamily:"system-ui, -apple-system, sans-serif"}),document.body.appendChild(o)}function _e(t){H();const e=document.createElement("div");e.id="translate-hover-tooltip",e.innerHTML=`
    <div style="display: flex; align-items: center; gap: 8px;">
      <div class="hover-spinner"></div>
      <span>Translating...</span>
    </div>
  `,Object.assign(e.style,{position:"fixed",top:`${Math.max(8,t.top-40)}px`,left:`${Math.max(8,Math.min(t.left,window.innerWidth-150))}px`,padding:"6px 12px",background:"#1e293b",color:"#94a3b8",borderRadius:"6px",fontSize:"12px",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.2)",zIndex:"2147483647",pointerEvents:"none",fontFamily:"system-ui, -apple-system, sans-serif"}),document.body.appendChild(e)}function H(){const t=document.getElementById("translate-hover-tooltip");t&&t.remove()}function gt(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}let y=null,et=!1,It={x:20,y:20},ft=!1,Rt={x:0,y:0},pt=!1;const nt=[];function qt(t){if(!ft||!y)return;const e=Math.max(0,Math.min(window.innerWidth-280,t.clientX-Rt.x)),n=Math.max(0,Math.min(window.innerHeight-200,t.clientY-Rt.y));y.style.left=`${e}px`,y.style.top=`${n}px`,y.style.right="auto",It={x:e,y:n}}function Ut(){ft&&y&&(y.style.transition="transform 0.2s ease, box-shadow 0.2s ease",ft=!1)}function Gt(){pt||(document.addEventListener("mousemove",qt),document.addEventListener("mouseup",Ut),pt=!0)}function Xt(){pt&&(document.removeEventListener("mousemove",qt),document.removeEventListener("mouseup",Ut),pt=!1)}function Pe(){const t=document.createElement("div");t.id="translate-floating-widget",t.innerHTML=`
    <div class="widget-header">
      <span class="widget-title">TRANSLATE!</span>
      <button class="widget-close" title="Close">&times;</button>
    </div>
    <div class="widget-body">
      <textarea class="widget-input" placeholder="Enter text to translate..." rows="2"></textarea>
      <div class="widget-controls">
        <select class="widget-lang-select">
          <option value="en">English</option>
          <option value="fi">Finnish</option>
          <option value="sv">Swedish</option>
          <option value="de">German</option>
          <option value="fr">French</option>
          <option value="es">Spanish</option>
          <option value="nl">Dutch</option>
          <option value="it">Italian</option>
          <option value="pt">Portuguese</option>
          <option value="ja">Japanese</option>
          <option value="zh">Chinese</option>
          <option value="ko">Korean</option>
          <option value="ru">Russian</option>
        </select>
        <button class="widget-translate-btn">Translate</button>
      </div>
      <div class="widget-output"></div>
      <div class="widget-history"></div>
    </div>
  `,Object.assign(t.style,{position:"fixed",top:`${It.y}px`,right:`${It.x}px`,width:"280px",background:"linear-gradient(135deg, #1e293b 0%, #0f172a 100%)",borderRadius:"12px",boxShadow:"0 10px 40px rgba(0, 0, 0, 0.3)",zIndex:"2147483646",fontFamily:"system-ui, -apple-system, sans-serif",color:"#f1f5f9",overflow:"hidden",transition:"transform 0.2s ease, box-shadow 0.2s ease"});const e=t.querySelector(".widget-header");Object.assign(e.style,{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 12px",background:"rgba(255,255,255,0.05)",cursor:"move",userSelect:"none"});const n=t.querySelector(".widget-title");Object.assign(n.style,{fontSize:"12px",fontWeight:"600",letterSpacing:"0.5px"});const o=t.querySelector(".widget-close");Object.assign(o.style,{background:"none",border:"none",color:"#94a3b8",fontSize:"18px",cursor:"pointer",padding:"0",lineHeight:"1"});const r=t.querySelector(".widget-body");Object.assign(r.style,{padding:"12px",display:"flex",flexDirection:"column",gap:"10px"});const a=t.querySelector(".widget-input");Object.assign(a.style,{width:"100%",padding:"8px 10px",border:"1px solid #334155",borderRadius:"6px",background:"#0f172a",color:"#f1f5f9",fontSize:"13px",resize:"none",outline:"none",fontFamily:"inherit",boxSizing:"border-box"});const i=t.querySelector(".widget-controls");Object.assign(i.style,{display:"flex",gap:"8px"});const l=t.querySelector(".widget-lang-select");Object.assign(l.style,{flex:"1",padding:"6px 8px",border:"1px solid #334155",borderRadius:"6px",background:"#0f172a",color:"#f1f5f9",fontSize:"12px",cursor:"pointer"});const s=t.querySelector(".widget-translate-btn");Object.assign(s.style,{padding:"6px 14px",border:"none",borderRadius:"6px",background:"#3b82f6",color:"white",fontSize:"12px",fontWeight:"500",cursor:"pointer"});const c=t.querySelector(".widget-output");Object.assign(c.style,{minHeight:"40px",padding:"10px",background:"rgba(255,255,255,0.05)",borderRadius:"6px",fontSize:"13px",lineHeight:"1.5",display:"none"});const d=t.querySelector(".widget-history");return Object.assign(d.style,{maxHeight:"100px",overflowY:"auto",fontSize:"11px",color:"#94a3b8"}),o.addEventListener("click",()=>Kt()),s.addEventListener("click",async()=>{const u=a.value.trim();if(u){s.textContent="...",s.disabled=!0;try{const g=await S.runtime.sendMessage({type:"translate",text:u,sourceLang:"auto",targetLang:l.value,options:{strategy:"fast"}});g.success&&g.result?(c.textContent=g.result,c.style.display="block",We(u,g.result)):(c.textContent="Translation failed",c.style.display="block")}catch(g){c.textContent="Error: "+String(g),c.style.display="block"}s.textContent="Translate",s.disabled=!1}}),a.addEventListener("keydown",u=>{u.key==="Enter"&&!u.shiftKey&&(u.preventDefault(),s.click())}),e.addEventListener("mousedown",u=>{ft=!0;const g=t.getBoundingClientRect();Rt={x:u.clientX-g.left,y:u.clientY-g.top},t.style.transition="none"}),at(["targetLang"]).then(u=>{u.targetLang&&(l.value=u.targetLang)}),t}function We(t,e){nt.unshift({original:t,translated:e}),nt.length>5&&nt.pop(),je()}function je(){if(!y)return;const t=y.querySelector(".widget-history");if(t){if(nt.length===0){t.style.display="none";return}t.style.display="block",t.innerHTML=nt.map(e=>`
    <div style="padding: 4px 0; border-bottom: 1px solid #334155;">
      <div style="color: #64748b;">${gt(e.original.substring(0,30))}${e.original.length>30?"...":""}</div>
      <div style="color: #94a3b8;">${gt(e.translated.substring(0,30))}${e.translated.length>30?"...":""}</div>
    </div>
  `).join("")}}function Yt(){if(y){y.style.display="block",et=!0,Gt();return}y=Pe(),document.body.appendChild(y),et=!0,Gt();const t=y.querySelector(".widget-input");setTimeout(()=>t?.focus(),100)}function Kt(){y&&(y.style.display="none",et=!1,Xt())}function qe(){return et?Kt():Yt(),et}async function Ue(t){if(!G)return;const e=He(t.clientX,t.clientY);if(!e){H();return}const{text:n,range:o}=e;if(n===At)return;At=n;const r=o.getBoundingClientRect(),a=n.toLowerCase(),i=A.get(a);if(i!==void 0){A.delete(a),A.set(a,i),jt(n,i,r);return}_e(r);try{const l=await at(["targetLang","provider"]),s=l.targetLang||"en",c=l.provider||"opus-mt",d=await S.runtime.sendMessage({type:"translate",text:n,sourceLang:"auto",targetLang:s,options:{strategy:"fast"},provider:c});if(d.success&&d.result){const u=d.result;if(A.delete(a),A.set(a,u),A.size>100){const g=A.keys().next().value;g&&A.delete(g)}jt(n,u,r)}else H()}catch(l){f.error("Hover translation failed:",l),H()}}function Jt(t){G&&(Lt!==null&&clearTimeout(Lt),Lt=window.setTimeout(()=>{Ue(t)},150))}function Vt(t){t.key==="Alt"&&!G&&(G=!0,document.body.style.cursor="help")}function Zt(t){t.key==="Alt"&&(G=!1,document.body.style.cursor="",H(),At="")}document.addEventListener("mousemove",Jt,{passive:!0}),document.addEventListener("keydown",Vt),document.addEventListener("keyup",Zt),window.addEventListener("blur",()=>{G=!1,document.body.style.cursor="",H()});let X=!1;function Qt(t){const e=t.getAttribute(j);if(!e||t.querySelector(".translate-bilingual-original"))return;const n=document.createElement("span");n.className="translate-bilingual-original",n.textContent=e,n.setAttribute("aria-hidden","true"),t.appendChild(n),t.classList.add("translate-bilingual")}function Ge(t){const e=t.querySelector(".translate-bilingual-original");e&&e.remove(),t.classList.remove("translate-bilingual")}function te(){X=!0,document.querySelectorAll(`[${B}]`).forEach(e=>Qt(e)),f.info("Bilingual mode enabled"),x("Bilingual mode: showing originals")}function ee(){X=!1,document.querySelectorAll(".translate-bilingual").forEach(e=>Ge(e)),f.info("Bilingual mode disabled"),x("Bilingual mode off")}function Xe(){return X?ee():te(),X}function ne(){return X}function mt(t){const e=Mt.get(t);if(e!==void 0)return e;const n=Ye(t);return Mt.set(t,n),n}function Ye(t){if(Fe.has(t.tagName)||t.getAttribute(B)||t.isContentEditable||t.hasAttribute("data-no-translate")||t.getAttribute("translate")==="no")return!0;try{const e=window.getComputedStyle(t);if(e.display==="none"||e.visibility==="hidden")return!0}catch{return!0}return!1}const Ke=/^[\s\d\p{P}\p{S}]+$/u,Je=/^(https?:|www\.|\/\/|{|}|\[|\]|function|const |let |var )/;function Ot(t){if(!t)return!1;const e=t.trim();return!(e.length<v.batching.minTextLength||e.length>v.batching.maxTextLength||Ke.test(e)||Je.test(e))}function oe(t){return t.normalize("NFC").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"").replace(/[ \t]+/g," ").trim()}function re(t){const e=[],n=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:r=>{const a=r.parentElement;return!a||mt(a)||!Ot(r.textContent)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});let o;for(;o=n.nextNode();)e.push(o);return e}function Ve(t){const e=[];for(const n of t)if(n.nodeType===Node.TEXT_NODE){const o=n.parentElement;o&&!mt(o)&&Ot(n.textContent)&&e.push(n)}else if(n.nodeType===Node.ELEMENT_NODE){const o=n;mt(o)||e.push(...re(o))}return e}function Ze(){const t=window.getSelection();if(!t||t.rangeCount===0)return null;const n=t.getRangeAt(0).commonAncestorContainer,o=n.nodeType===Node.TEXT_NODE?n.parentElement?.closest("p, div, article, section, li, td, th, blockquote, h1, h2, h3, h4, h5, h6"):n.closest("p, div, article, section, li, td, th, blockquote, h1, h2, h3, h4, h5, h6");if(!o)return null;const r=o.textContent||"",a=t.toString(),i=r.indexOf(a);if(i===-1)return null;const l=150,s=r.slice(Math.max(0,i-l),i).trim(),c=r.slice(i+a.length,i+a.length+l).trim();return!s&&!c?null:{before:s,after:c}}async function $t(){if(tt===null)try{tt=await St.getGlossary()}catch(t){f.error(" Failed to load glossary:",t),tt={}}return tt}async function Qe(t,e,n,o){const r=window.getSelection();if(!r||r.isCollapsed){f.info(" No text selected"),x("Select text to translate");return}const a=r.toString().trim();if(!Ot(a)){f.info(" Selected text is not valid for translation"),x("Select text to translate");return}const i=oe(a),l=Ze();f.info("Translating selection with context:",{text:i.substring(0,50),contextBefore:l?.before?.substring(0,30),contextAfter:l?.after?.substring(0,30)});try{const s=await $t(),{processedText:c,restore:d}=await St.applyGlossary(i,s),u=await S.runtime.sendMessage({type:"translate",text:c,sourceLang:t,targetLang:e,options:{strategy:n,context:l||void 0},provider:o});if(u.success&&u.result){const g=d(u.result);ln(g,r.getRangeAt(0))}else f.error(" Translation failed:",u.error),de(u.error||"Translation failed",r.getRangeAt(0))}catch(s){f.error(" Translation error:",s);const c=s instanceof Error?s.message:"Unknown error";de(c,r.getRangeAt(0))}}async function ht(t,e,n,o,r,a=!1,i=2){let l=null;for(let s=0;s<=i;s++)try{if(s>0){const g=Math.min(1e3*Math.pow(2,s-1),5e3);await new Promise(I=>setTimeout(I,g)),console.log(`[Content] Retry attempt ${s} for batch`)}const c=performance.now(),d=await S.runtime.sendMessage({type:"translate",text:t.texts,sourceLang:e,targetLang:n,options:{strategy:o},provider:r,enableProfiling:a}),u=performance.now()-c;if(lt("ipcRoundtrip",u),d.success&&Array.isArray(d.result)){const g=performance.now();let I=0,k=0;d.result.forEach(($,J)=>{const h=t.nodes[J];if(h&&$&&h.parentElement&&document.contains(h)&&!h.parentElement.hasAttribute(B))try{const T=t.restoreFns[J]($),E=h.textContent||"",V=E.match(/^\s*/)?.[0]||"",Z=E.match(/\s*$/)?.[0]||"";h.parentElement.hasAttribute(j)||h.parentElement.setAttribute(j,E),h.parentElement.setAttribute(Ht,T),h.parentElement.setAttribute(_t,e),h.parentElement.setAttribute(Pt,n),h.textContent=V+T+Z,h.parentElement.setAttribute(B,"true"),Be(h.parentElement),X&&Qt(h.parentElement),I++}catch{k++}});const w=performance.now()-g;return lt("domUpdate",w),{translatedCount:I,errorCount:k,ipcTime:u,domUpdateTime:w}}if(d.error&&!ae(d.error))return{translatedCount:0,errorCount:t.nodes.length,ipcTime:u,domUpdateTime:0};l=d.error||"Translation returned unsuccessful response"}catch(c){if(l=c,c instanceof Error&&c.message.includes("Extension context invalidated"))return console.warn("[Content] Extension context invalidated — stopping translation. Reload the page."),bt(),p=null,{translatedCount:0,errorCount:t.nodes.length,ipcTime:0,domUpdateTime:0};if(s===i)break}return console.error(`[Content] Batch failed after ${i+1} attempts:`,l),{translatedCount:0,errorCount:t.nodes.length,ipcTime:0,domUpdateTime:0}}const tn=/timeout|network|connection|econnreset|fetch failed|service worker|disconnected|offscreen|loading model/i;function ae(t){return tn.test(t)}let Y=null;function Ft(){Y&&(Y.disconnect(),Y=null)}async function ie(t,e,n,o,r=!1){if(ct){f.info(" Translation already in progress");return}ct=!0,Ft(),f.info(" Translating page...");const a=performance.now();try{const i=performance.now(),l=re(document.body),s=performance.now()-i;if(lt("domScan",s),console.log(`[Content] Found ${l.length} text nodes in ${s.toFixed(2)}ms`),l.length===0){f.info(" No translatable text found");return}const c=window.innerHeight,d=[],u=[];for(const m of l){const R=m.parentElement;if(R)try{const O=R.getBoundingClientRect();O.top<c&&O.bottom>0?d.push(m):u.push({node:m,top:O.top})}catch{u.push({node:m,top:1/0})}}u.sort((m,R)=>m.top-R.top);const g=u.map(m=>m.node);console.log(`[Content] Viewport: ${d.length} nodes, below fold: ${g.length} nodes`);const I=performance.now(),k=await $t(),w=performance.now()-I;lt("glossaryApply",w);const $=await yt(d,k),J=$.length,h=g.length>0;(J>1||h)&&Ne("Translating visible content...");let T=0,E=0,V=0,Z=0,fe=!0;const pe=2;for(let m=0;m<$.length;m+=pe){const R=$.slice(m,m+pe);J>1&&Wt(`Translating... ${m+1}/${J}`);const O=await Promise.all(R.map(F=>ht(F,t,e,n,o,r)));for(let F=0;F<O.length;F++){const _=O[F];if(fe&&_.translatedCount>0){const P=R[F].nodes[0];P?.parentElement&&ze(P.parentElement),fe=!1}T+=_.translatedCount,E+=_.errorCount,V+=_.ipcTime,Z+=_.domUpdateTime}}if(g.length>0){Wt("Translating remaining content...");const m=Math.min(g.length,v.batching.maxSize*2),R=g.slice(0,m),O=g.slice(m),F=await yt(R,k);for(const _ of F){const P=await ht(_,t,e,n,o,r);T+=P.translatedCount,E+=P.errorCount,V+=P.ipcTime,Z+=P.domUpdateTime}O.length>0&&en(O,t,e,n,k,o,r)}dt();const vt=performance.now()-a;if(console.log(`[Content] Page translation complete: ${T} translated, ${E} errors
  Total: ${vt.toFixed(2)}ms
  DOM Scan: ${s.toFixed(2)}ms (${(s/vt*100).toFixed(1)}%)
  IPC Total: ${V.toFixed(2)}ms (${(V/vt*100).toFixed(1)}%)
  DOM Update: ${Z.toFixed(2)}ms (${(Z/vt*100).toFixed(1)}%)`),E>0&&T>0)x(`Translated ${T} items (${E} failed)`);else if(T>0&&E===0){const m=g.length>v.batching.maxSize*2?" (more translates as you scroll)":"";x(`Translated ${T} items${m}`)}else E>0&&T===0&&L("Translation failed. Please try again.");r&&console.log("[Content] Timing Stats:",$e())}finally{if(ct=!1,Q.length>0&&p){const i=Q;Q=[],f.info(` Draining ${i.length} queued dynamic nodes`),xt(i)}}}async function yt(t,e){const n=[];for(let o=0;o<t.length;o+=v.batching.maxSize){const r=t.slice(o,o+v.batching.maxSize),a=r.map(s=>{const c=oe(s.textContent||"");return c.length>v.batching.maxTextLength?c.substring(0,v.batching.maxTextLength):c}),{processedTexts:i,restoreFns:l}=await St.applyGlossaryBatch(a,e);n.push({nodes:r,texts:i,restoreFns:l})}return n}function en(t,e,n,o,r,a,i=!1){const l=v.batching.maxSize*2,s=[];for(let d=0;d<t.length;d+=l)s.push(t.slice(d,d+l));console.log(`[Content] Deferring ${t.length} nodes in ${s.length} scroll-triggered chunks`);const c=new Set;Y=new IntersectionObserver(async d=>{for(const u of d){if(!u.isIntersecting)continue;const g=Number(u.target.dataset.translateChunk);if(isNaN(g)||c.has(g))continue;c.add(g),Y?.unobserve(u.target);const I=s[g];if(!I||!p)return;const k=I.filter(w=>w.parentElement&&document.contains(w)&&!w.parentElement.hasAttribute(B));if(k.length===0)return;console.log(`[Content] Scroll-triggered: translating chunk ${g+1}/${s.length} (${k.length} nodes)`);try{const w=await yt(k,r);for(const $ of w)await ht($,e,n,o,a,i)}catch(w){console.error(`[Content] Scroll-triggered translation error for chunk ${g}:`,w)}}},{rootMargin:"200% 0px"});for(let d=0;d<s.length;d++){const g=s[d][0]?.parentElement;!g||!document.contains(g)||(g.dataset.translateChunk=String(d),Y.observe(g))}}async function xt(t){if(!p)return;if(ct){Q.push(...t);return}if(kt)return;kt=!0;const e=Ve(t);if(e.length!==0){console.log(`[Content] Translating ${e.length} dynamic text nodes`);try{const n=await $t(),o=await yt(e,n);for(const r of o){if(!p)return;const a=await ht(r,p.sourceLang,p.targetLang,p.strategy,p.provider,!1,1);a.errorCount>0&&a.translatedCount===0&&f.error(` Dynamic batch fully failed (${a.errorCount} nodes)`)}}catch(n){f.error(" Dynamic translation error:",n),n instanceof Error&&!ae(n.message)&&L(n.message)}finally{kt=!1}}}function nn(){bt(),p=null;const t=wt.length;ce();const e=document.querySelectorAll(`[${B}]`);let n=t;return e.forEach(o=>{const r=o.getAttribute(j);if(r!==null){const a=Array.from(o.childNodes).find(i=>i.nodeType===Node.TEXT_NODE);a&&(a.textContent=r,n++)}o.removeAttribute(B),o.removeAttribute(j),Mt.delete(o)}),f.info(` Restored ${n} elements to original text`),x(`Restored ${n} translations`),n}const ot=100;function on(){if(q.length===0)return;const t=[];for(const e of q)for(const n of e.addedNodes)(n.nodeType===Node.ELEMENT_NODE||n.nodeType===Node.TEXT_NODE)&&t.push(n);if(q=[],t.length!==0)if(t.length<=ot)xt(t);else{xt(t.slice(0,ot));let e=ot;const n=()=>{if(e>=t.length)return;const o=t.slice(e,e+ot);e+=ot,xt(o),e<t.length&&("requestIdleCallback"in window?window.requestIdleCallback(n):setTimeout(n,50))};"requestIdleCallback"in window?window.requestIdleCallback(n):setTimeout(n,50)}}function se(){U||(U=new MutationObserver(t=>{for(const e of t)q.length<v.mutations.maxPending&&q.push(e);D!==null&&clearTimeout(D),D=window.setTimeout(()=>{D=null,on()},v.mutations.debounceMs)}),U.observe(document.body,{childList:!0,subtree:!0}),f.info(" MutationObserver started"))}function bt(){U&&(U.disconnect(),U=null),D!==null&&(clearTimeout(D),D=null),q=[],Ft(),dt(),f.info(" MutationObserver stopped")}let wt=[];function rn(t,e){const n=document.createElement("div");n.className="translate-image-overlay";const o=t.getBoundingClientRect(),r=o.width/t.naturalWidth,a=o.height/t.naturalHeight;return Object.assign(n.style,{position:"absolute",top:`${o.top+window.scrollY}px`,left:`${o.left+window.scrollX}px`,width:`${o.width}px`,height:`${o.height}px`,pointerEvents:"none",zIndex:"999998"}),e.forEach(i=>{const l=document.createElement("div");l.className="translate-image-block",l.textContent=i.translated;const s=(i.bbox.x1-i.bbox.x0)*r,c=(i.bbox.y1-i.bbox.y0)*a,d=Math.max(10,Math.min(c*.7,24));Object.assign(l.style,{position:"absolute",left:`${i.bbox.x0*r}px`,top:`${i.bbox.y0*a}px`,width:`${s}px`,minHeight:`${c}px`,background:"rgba(255, 255, 255, 0.95)",color:"#1e293b",padding:"2px 4px",fontSize:`${d}px`,lineHeight:"1.2",overflow:"hidden",borderRadius:"2px",boxShadow:"0 1px 3px rgba(0,0,0,0.2)",display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center",wordBreak:"break-word"}),l.title=`Original: ${i.original}`,n.appendChild(l)}),document.body.appendChild(n),wt.push(n),n}function le(t){const e=document.querySelectorAll("img");for(const n of e)if(n.src===t||n.currentSrc===t)return n;return null}async function an(t){const e=le(t);if(e&&e.complete&&e.naturalWidth>0){const n=document.createElement("canvas");n.width=e.naturalWidth,n.height=e.naturalHeight;const o=n.getContext("2d");if(!o)throw new Error("Canvas not supported");return o.drawImage(e,0,0),n.toDataURL("image/png")}try{const o=await(await fetch(t,{mode:"cors"})).blob();return new Promise((r,a)=>{const i=new FileReader;i.onload=()=>r(i.result),i.onerror=a,i.readAsDataURL(o)})}catch{return new Promise((o,r)=>{const a=new Image;a.crossOrigin="anonymous",a.onload=()=>{const i=document.createElement("canvas");i.width=a.naturalWidth,i.height=a.naturalHeight;const l=i.getContext("2d");if(!l){r(new Error("Canvas not supported"));return}l.drawImage(a,0,0);try{o(i.toDataURL("image/png"))}catch{r(new Error("Cannot access image due to CORS policy"))}},a.onerror=()=>r(new Error("Failed to load image")),a.src=t})}}async function sn(t,e,n,o){x("Extracting text from image...");try{let r;try{r=await an(t)}catch(s){f.error("Failed to load image:",s),L("Cannot access image (CORS restriction)");return}const a=await S.runtime.sendMessage({type:"ocrImage",imageData:r,lang:e!=="auto"?e:void 0});if(!a.success){L(a.error||"OCR failed");return}if(!a.blocks||a.blocks.length===0){x("No text found in image");return}f.info(`OCR found ${a.blocks.length} text blocks (${a.confidence?.toFixed(1)}% confidence)`),x(`Translating ${a.blocks.length} text blocks...`);const i=[];for(const s of a.blocks)if(!(s.text.trim().length<2)){if(s.confidence<50){f.debug(`Skipping low confidence block: "${s.text}" (${s.confidence.toFixed(1)}%)`);continue}try{const c=await S.runtime.sendMessage({type:"translate",text:s.text,sourceLang:e,targetLang:n,provider:o});c.success&&c.result&&i.push({original:s.text,translated:c.result,bbox:s.bbox})}catch(c){f.warn(`Failed to translate block: "${s.text}"`,c)}}if(i.length===0){x("Could not translate image text");return}const l=le(t);l?(rn(l,i),x(`Translated ${i.length} text blocks`)):(f.warn("Could not find image element for overlay"),x(`Translated ${i.length} blocks (overlay unavailable)`))}catch(r){f.error("Image translation failed:",r);const a=r instanceof Error?r.message:String(r);a.includes("CORS")||a.includes("cross-origin")?L("Cannot translate: Image is from another website (CORS blocked)"):a.includes("Canvas")||a.includes("tainted")?L("Cannot translate: Browser security prevents accessing this image"):a.includes("timeout")||a.includes("Timeout")?L("Image translation timed out. Try a smaller image."):L("Image translation failed: "+a.substring(0,50))}}function ce(){wt.forEach(t=>t.remove()),wt=[]}function ln(t,e){K();const n=e.getBoundingClientRect(),o=document.createElement("div");o.id="translate-tooltip",o.textContent=t,o.style.cssText=`
    position: fixed;
    top: ${Math.min(n.bottom+8,window.innerHeight-100)}px;
    left: ${Math.max(8,Math.min(n.left,window.innerWidth-416))}px;
    max-width: 400px;
    padding: 12px 16px;
    background: #1e293b;
    color: white;
    border-radius: 8px;
    font-size: 14px;
    line-height: 1.5;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    z-index: 999999;
    animation: translateFadeIn 0.2s ease;
    word-wrap: break-word;
  `;const r=document.createElement("button");r.innerHTML="&times;",r.style.cssText=`
    position: absolute;
    top: 4px;
    right: 8px;
    background: none;
    border: none;
    color: #94a3b8;
    font-size: 18px;
    cursor: pointer;
    padding: 0;
    line-height: 1;
  `,r.onclick=()=>K(),o.appendChild(r),document.body.appendChild(o),setTimeout(()=>K(),1e4)}function de(t,e){K();const n=e.getBoundingClientRect(),o=document.createElement("div");o.id="translate-tooltip",o.style.cssText=`
    position: fixed;
    top: ${Math.min(n.bottom+8,window.innerHeight-100)}px;
    left: ${Math.max(8,Math.min(n.left,window.innerWidth-416))}px;
    max-width: 400px;
    padding: 12px 16px;
    background: #991b1b;
    color: white;
    border-radius: 8px;
    font-size: 14px;
    line-height: 1.5;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    z-index: 999999;
    animation: translateFadeIn 0.2s ease;
  `,o.textContent=t;const r=document.createElement("button");r.innerHTML="&times;",r.style.cssText=`
    position: absolute;
    top: 4px;
    right: 8px;
    background: none;
    border: none;
    color: #fca5a5;
    font-size: 18px;
    cursor: pointer;
    padding: 0;
    line-height: 1;
  `,r.onclick=()=>K(),o.appendChild(r),document.body.appendChild(o),setTimeout(()=>K(),5e3)}function K(){const t=document.getElementById("translate-tooltip");t&&t.remove()}const ue=document.createElement("style");ue.textContent=`
  @keyframes translateFadeIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes hoverFadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .hover-spinner {
    width: 12px;
    height: 12px;
    border: 2px solid #475569;
    border-top-color: #60a5fa;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .hover-original { color: #94a3b8; }
  .hover-arrow { color: #60a5fa; font-weight: bold; }
  .hover-translation { color: #f1f5f9; font-weight: 500; }

  /* Bilingual Reading Mode - non-destructive annotation */
  .translate-bilingual {
    position: relative;
  }
  .translate-bilingual-original {
    display: block;
    font-size: 0.8em;
    line-height: 1.3;
    color: #6b7280;
    font-style: italic;
    opacity: 0.7;
    margin-top: 1px;
    pointer-events: none;
    user-select: none;
  }
  /* Inline elements (span, a, em, strong) — keep annotation inline-block to avoid breaking flow */
  span.translate-bilingual > .translate-bilingual-original,
  a.translate-bilingual > .translate-bilingual-original,
  em.translate-bilingual > .translate-bilingual-original,
  strong.translate-bilingual > .translate-bilingual-original {
    display: inline-block;
    margin-top: 0;
    margin-left: 4px;
    vertical-align: baseline;
  }
  /* Inline elements: parenthesized format for compact display */
  span.translate-bilingual > .translate-bilingual-original::before { content: '('; }
  span.translate-bilingual > .translate-bilingual-original::after { content: ')'; }
  a.translate-bilingual > .translate-bilingual-original::before { content: '('; }
  a.translate-bilingual > .translate-bilingual-original::after { content: ')'; }
  em.translate-bilingual > .translate-bilingual-original::before { content: '('; }
  em.translate-bilingual > .translate-bilingual-original::after { content: ')'; }
  strong.translate-bilingual > .translate-bilingual-original::before { content: '('; }
  strong.translate-bilingual > .translate-bilingual-original::after { content: ')'; }
  @media (prefers-color-scheme: dark) {
    .translate-bilingual-original {
      color: #9ca3af;
    }
  }

  /* Image Translation Overlay */
  .translate-image-overlay {
    pointer-events: none;
  }
  .translate-image-block {
    pointer-events: auto;
    cursor: help;
    transition: transform 0.1s ease;
  }
  .translate-image-block:hover {
    transform: scale(1.02);
    z-index: 1;
  }
`,document.head.appendChild(ue),S.runtime.onMessage.addListener((t,e,n)=>{if(t.type==="ping")return n({loaded:!0}),!0;if(t.type==="stopAutoTranslate")return bt(),p=null,n(!0),!0;if(t.type==="undoTranslation"){const o=nn();return n({success:!0,restoredCount:o}),!0}if(t.type==="toggleBilingualMode"){const o=Xe();return n({enabled:o}),!0}if(t.type==="setBilingualMode")return t.enabled?te():ee(),n({enabled:ne()}),!0;if(t.type==="getBilingualMode")return n({enabled:ne()}),!0;if(t.type==="toggleWidget"){const o=qe();return n({visible:o}),!0}return t.type==="showWidget"?(Yt(),n({visible:!0}),!0):t.type==="translateSelection"?(Qe(t.sourceLang,t.targetLang,t.strategy,t.provider).then(()=>n(!0)).catch(()=>n(!1)),!0):t.type==="translatePage"?(p={sourceLang:t.sourceLang,targetLang:t.targetLang,strategy:t.strategy,provider:t.provider},ie(t.sourceLang,t.targetLang,t.strategy,t.provider).then(()=>{se(),n(!0)}).catch(()=>n(!1)),!0):t.type==="translateImage"?(sn(t.imageUrl,t.sourceLang,t.targetLang,t.provider).then(()=>n(!0)).catch(()=>n(!1)),!0):!1});async function ge(){const t=window.location.hostname,e=await ve.getRules(t),n=await at(["autoTranslate","sourceLang","targetLang","strategy","provider"]),o=e?.autoTranslate??n.autoTranslate,r=e?.sourceLang||n.sourceLang||"auto",a=e?.targetLang||n.targetLang||"fi",i=e?.strategy||n.strategy||"smart",l=e?.preferredProvider||n.provider||"opus-mt";if(e&&f.info(" Site-specific rules found for",t,e),o){f.info(" Auto-translate enabled, waiting for page idle..."),p={sourceLang:r,targetLang:a,strategy:i,provider:l};const s=()=>{p&&ie(p.sourceLang,p.targetLang,p.strategy,p.provider).then(()=>{se()})};"requestIdleCallback"in window?window.requestIdleCallback(s,{timeout:2e3}):setTimeout(s,500)}}document.readyState==="complete"?ge():window.addEventListener("load",ge),window.addEventListener("unload",()=>{bt(),Ft(),dt(),ce(),A.clear(),Q=[],p=null,tt=null,document.removeEventListener("mousemove",Jt),document.removeEventListener("keydown",Vt),document.removeEventListener("keyup",Zt),Xt()}),f.info(" Translation content script loaded v2.3 with MutationObserver + site rules + glossary support")})();
//# sourceMappingURL=content.js.map
